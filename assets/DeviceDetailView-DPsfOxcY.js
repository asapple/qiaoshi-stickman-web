import{d as H,v as W,x as L,y as ae,z as Ve,a as i,A as F,L as xe,C as ie,D as Y,E as Z,r as f,G as Te,H as $e,J as Pe,K as ze,M as Se,O as Ne,o as le,Q as ee,R as Le,S as je,U as oe,I as j,n as Ee,c as T,b as s,u as d,N as Ue,w as C,P as A,e as p,F as R,h as G,j as O,B as U,i as D,g as M,t as P,V as te,l as q,p as V,q as De,f as Fe,_ as Be}from"./index-0YGLxGz1.js";import{V as We}from"./VideoPlayer-C5mpMWVh.js";import{G as Ae,a as Re}from"./index-CaiDyVZr.js";const[Ge,J]=ae("switch"),Oe={size:L,loading:Boolean,disabled:Boolean,modelValue:W,activeColor:String,inactiveColor:String,activeValue:{type:W,default:!0},inactiveValue:{type:W,default:!1}};var Me=H({name:Ge,props:Oe,emits:["change","update:modelValue"],setup(n,{emit:$,slots:l}){const g=()=>n.modelValue===n.activeValue,u=()=>{if(!n.disabled&&!n.loading){const v=g()?n.inactiveValue:n.activeValue;$("update:modelValue",v),$("change",v)}},m=()=>{if(n.loading){const v=g()?n.activeColor:n.inactiveColor;return i(xe,{class:J("loading"),color:v},null)}if(l.node)return l.node()};return Ve(()=>n.modelValue),()=>{var v;const{size:x,loading:r,disabled:b,activeColor:I,inactiveColor:w}=n,y=g(),h={fontSize:F(x),backgroundColor:y?I:w};return i("div",{role:"switch",class:J({on:y,loading:r,disabled:b}),style:h,tabindex:b?void 0:0,"aria-checked":y,onClick:u},[i("div",{class:J("node")},[m()]),(v=l.background)==null?void 0:v.call(l)])}}});const se=ie(Me),[qe,z]=ae("image"),Je={src:String,alt:String,fit:String,position:String,round:Boolean,block:Boolean,width:L,height:L,radius:L,lazyLoad:Boolean,iconSize:L,showError:Z,errorIcon:Y("photo-fail"),iconPrefix:String,showLoading:Z,loadingIcon:Y("photo"),crossorigin:String,referrerpolicy:String,decoding:String};var He=H({name:qe,props:Je,emits:["load","error"],setup(n,{emit:$,slots:l}){const g=f(!1),u=f(!0),m=f(),{$Lazyload:v}=Te().proxy,x=$e(()=>{const a={width:F(n.width),height:F(n.height)};return Pe(n.radius)&&(a.overflow="hidden",a.borderRadius=F(n.radius)),a});ze(()=>n.src,()=>{g.value=!1,u.value=!0});const r=a=>{u.value&&(u.value=!1,$("load",a))},b=()=>{const a=new Event("load");Object.defineProperty(a,"target",{value:m.value,enumerable:!0}),r(a)},I=a=>{g.value=!0,u.value=!1,$("error",a)},w=(a,_,k)=>k?k():i(j,{name:a,size:n.iconSize,class:_,classPrefix:n.iconPrefix},null),y=()=>{if(u.value&&n.showLoading)return i("div",{class:z("loading")},[w(n.loadingIcon,z("loading-icon"),l.loading)]);if(g.value&&n.showError)return i("div",{class:z("error")},[w(n.errorIcon,z("error-icon"),l.error)])},h=()=>{if(g.value||!n.src)return;const a={alt:n.alt,class:z("img"),decoding:n.decoding,style:{objectFit:n.fit,objectPosition:n.position},crossorigin:n.crossorigin,referrerpolicy:n.referrerpolicy};return n.lazyLoad?Le(i("img",oe({ref:m},a),null),[[je("lazy"),n.src]]):i("img",oe({ref:m,src:n.src,onLoad:r,onError:I},a),null)},S=({el:a})=>{const _=()=>{a===m.value&&u.value&&b()};m.value?_():ee(_)},N=({el:a})=>{a===m.value&&!g.value&&I()};return v&&Se&&(v.$on("loaded",S),v.$on("error",N),Ne(()=>{v.$off("loaded",S),v.$off("error",N)})),le(()=>{ee(()=>{var a;(a=m.value)!=null&&a.complete&&!n.lazyLoad&&b()})}),()=>{var a;return i("div",{class:z({round:n.round,block:n.block}),style:x.value},[h(),y(),(a=l.default)==null?void 0:a.call(l)])}}});const ne=ie(He),Qe={class:"device-detail-page"},Ke={class:"device-controls-card"},Xe={class:"control-list"},Ye={class:"control-item"},Ze={class:"control-item"},eo={class:"exception-images"},oo={class:"image-item"},to={class:"image-timestamp"},so={class:"wifi-popup"},no={class:"popup-content"},ao={class:"popup-footer"},io={class:"notifier-popup"},lo={class:"popup-header"},ro={class:"popup-content"},co={class:"search-section"},uo={class:"search-bar"},vo={class:"notifier-section"},fo={class:"notifier-info"},mo={class:"notifier-name"},po={class:"notifier-phone"},ho={key:0,class:"empty-state"},go={class:"notifier-section"},wo={class:"notifier-info"},yo={class:"notifier-name"},ko={class:"notifier-phone"},bo={key:0,class:"empty-state"},Io={key:0,class:"image-lightbox"},_o={class:"lightbox-info"},Co={class:"image-timestamp"},Vo=H({__name:"DeviceDetailView",setup(n){const $=Ee(),l=$.query.deviceId||"",g=$.query.boxId||"";console.log("deviceId:",l,"boxId:",g);const u=f(""),m=f(!1),v=f(!1),x=f(!1),r=f({ssid:"",password:""}),b=f(!1),I=f(""),w=f([]),y=f([]),h=f({}),S=f([]),N=f([]),a=f(!1),_=f(null),k=()=>localStorage.getItem("authToken")||"",re=async()=>{const t=k();try{const o=await(await fetch(`http://121.40.120.244:8080/realtime/play?deviceId=${l}&protocol=HTTPS_FLV`,{method:"GET",headers:{Authorization:t,"Content-Type":"application/json"}})).json();o.code===200?(h.value=o.data,console.log("获取流地址:",o.data),h.value.wifiName&&(r.value.ssid=h.value.wifiName),h.value.wifiPassword&&(r.value.password=h.value.wifiPassword),h.value?setTimeout(()=>{u.value=h.value,console.log("流地址：",u.value)},2e3):setTimeout(()=>{u.value="https://8.154.36.10/live/stream.live.flv"},2e3)):p("获取设备信息失败")}catch(e){console.error("请求失败",e),p("网络错误，请重试")}},ce=async()=>{const t=k();try{const o=await(await fetch(`http://121.40.120.244:8080/stickman/warning/box/${g}`,{method:"GET",headers:{Authorization:t,"Content-Type":"application/json"}})).json();o.code===200?(N.value=o.data,S.value=N.value.map(c=>({id:c.id,url:c.combinedImageUrl||c.processedImageUrl||c.imageUrl||"https://picsum.photos/300/200?random=1",timestamp:c.time?new Date(c.time).toLocaleString():""}))):p("获取设备历史异常信息失败")}catch(e){console.error("请求失败",e),p("网络错误，请重试")}},de=async()=>{const t=k();console.log("Token:",t);try{const o=await(await fetch("http://121.40.120.244:8080/stickman/recipient_directory",{method:"GET",headers:{Authorization:t,"Content-Type":"application/json"}})).json();console.log("获取联系人列表:",o),o.code===200?(w.value=o.data,B()):p("获取联系人失败")}catch(e){console.error("请求失败",e),p("网络错误，请重试")}},B=()=>{w.value=w.value.map(t=>({...t,isNotifier:y.value.some(e=>e.phone===t.phone)}))},Q=async t=>{const e=k();try{const c=await(await fetch(`http://121.40.120.244:8080/stickman/recipient?boxId=${t}&page=1&size=10`,{method:"GET",headers:{Authorization:e,"Content-Type":"application/json"}})).json();c.code===200?(console.log(c.data.records),y.value=c.data.records,B()):p("获取设备通知人失败")}catch(o){console.error("请求失败",o),p("网络错误，请重试")}},ue=async t=>{const e=k();try{const c=await(await fetch("http://121.40.120.244:8080/stickman/recipient",{method:"POST",headers:{Authorization:e,"Content-Type":"application/json"},body:JSON.stringify({boxId:parseInt(l),name:t.name,phone:t.phoneNumber})})).json();c.code===200?(console.log(c),q("绑定成功"),await Q(l)):p("绑定失败")}catch{p("网络错误，请重试")}},ve=async t=>{const e=parseInt(y.value[t].id,10),o=k();if(confirm("你确定要解绑这个设备通知人吗？"))try{(await(await fetch(`http://121.40.120.244:8080/stickman/recipient/${e}`,{method:"DELETE",headers:{Authorization:o,"Content-Type":"application/json"}})).json()).code===200?(y.value.splice(t,1),q("解绑成功"),B()):p("解绑失败")}catch{p("请求失败")}},K=async t=>{const e=w.value.find(o=>o.phone===t);if(e)if(e.isNotifier){const o=y.value.findIndex(c=>c.phone===t);o!==-1&&await ve(o)}else await ue(e)},fe=async t=>{const e=k();console.log("火柴人模式状态1:",t?"on":"off");try{if(t){m.value=t;const o=`https://8.154.36.10/inference/${l}.live.flv`;console.log("火柴人url：",o),(await(await fetch(`http://121.40.120.244:8080/realtime/inference?deviceId=${l}&rtsp=rtsp://8.154.36.10:554/rtp/${l}_${l}`,{method:"POST",headers:{Authorization:e,"Content-Type":"application/json"}})).json()).code===200?(console.log("火柴人请求成功url:",o),m.value=t,setTimeout(()=>{u.value=o,console.log("火柴人成功url:",u.value)},3e3)):(m.value=!1,console.log("火柴人请求失败"))}}catch(o){console.error("火柴人模式切换请求失败:",o),p("网络错误，请重试")}finally{console.log("火柴人模式状态:",t?"on":"off"),Fe()}t||setTimeout(()=>{u.value=h.value,console.log("url:",u.value)},2e3)},me=t=>{if(v.value=t,console.log("人像隐去状态:",t?"on":"off"),t){m.value=!0;const e=`https://8.154.36.10/inference/${l}_hidden.live.flv`;console.log("隐去人像url:",e),setTimeout(()=>{u.value=e},3e3)}else{const e=`https://8.154.36.10/inference/${l}.live.flv`;setTimeout(()=>{u.value=e},2e3)}},pe=()=>{x.value=!0},he=async()=>{if(!r.value.ssid){te("请输入WIFI名称");return}if(!r.value.password){te("请输入WIFI密码");return}const t=k();try{const o=await(await fetch(`http://121.40.120.244:8080/stickman/box/${l}`,{method:"PUT",headers:{Authorization:t,"Content-Type":"application/json"},body:JSON.stringify({...h.value,wifiName:r.value.ssid,wifiPassword:r.value.password})})).json();o.code===200?(console.log("RES:",o),q("修改设备配置信息成功"),h.value.wifiName=r.value.ssid,h.value.wifiPassword=r.value.password,r.value.ssid="",r.value.password="",x.value=!1):p("修改设备配置信息失败")}catch(e){console.error("请求失败",e),p("网络错误，请重试")}},ge=()=>{r.value.ssid="",r.value.password="",x.value=!1},we=async()=>{b.value=!0,await Q(l),await de()},E=()=>I.value?w.value.filter(t=>t.name.includes(I.value)||t.phone.includes(I.value)):w.value,ye=()=>{b.value=!1},ke=t=>{_.value=t,a.value=!0},X=()=>{a.value=!1,_.value=null},be=()=>{console.log("视频开始播放")},Ie=()=>{console.log("视频已暂停")},_e=t=>{console.error("视频播放错误:",t),p("视频播放失败: "+t)};return le(()=>{console.log("设备详情页加载，设备ID:",l),re(),ce()}),(t,e)=>(V(),T("div",Qe,[i(d(Ue),{title:"设备详情","left-arrow":"",onClickLeft:e[0]||(e[0]=()=>t.$router.back())}),i(We,{height:"250px","video-url":u.value,onPlay:be,onPause:Ie,onError:_e},null,8,["video-url"]),s("div",Ke,[e[13]||(e[13]=s("h2",{class:"card-title"},"设备管理",-1)),s("div",Xe,[s("div",Ye,[e[9]||(e[9]=s("span",{class:"control-label"},"火柴人模式",-1)),i(d(se),{modelValue:m.value,"onUpdate:modelValue":e[1]||(e[1]=o=>m.value=o),disabled:v.value,size:"20px",onChange:fe},null,8,["modelValue","disabled"])]),s("div",Ze,[e[10]||(e[10]=s("span",{class:"control-label"},"人像隐去",-1)),i(d(se),{modelValue:v.value,"onUpdate:modelValue":e[2]||(e[2]=o=>v.value=o),size:"20px",onChange:me},null,8,["modelValue"])]),s("div",{class:"control-item action-item",onClick:pe},[e[11]||(e[11]=s("span",{class:"control-label"},"配置WIFI",-1)),i(d(j),{name:"arrow"})]),s("div",{class:"control-item action-item",onClick:we},[e[12]||(e[12]=s("span",{class:"control-label"},"通知人管理",-1)),i(d(j),{name:"arrow"})])])]),s("div",eo,[e[14]||(e[14]=s("h2",{class:"section-title"},"异常事件记录",-1)),i(d(Ae),{"column-num":2,border:!1,gutter:"10"},{default:C(()=>[(V(!0),T(R,null,G(S.value,o=>(V(),De(d(Re),{key:o.id,onClick:c=>ke(o)},{default:C(()=>[s("div",oo,[i(d(ne),{src:o.url,width:"100%",height:"100px",fit:"cover",radius:"8"},null,8,["src"]),s("div",to,P(o.timestamp),1)])]),_:2},1032,["onClick"]))),128))]),_:1})]),i(d(A),{show:x.value,"onUpdate:show":e[5]||(e[5]=o=>x.value=o),position:"bottom",style:{height:"50%"},round:""},{default:C(()=>[s("div",so,[e[17]||(e[17]=s("div",{class:"popup-header"},[s("h2",null,"配置WIFI")],-1)),s("div",no,[i(d(O),{modelValue:r.value.ssid,"onUpdate:modelValue":e[3]||(e[3]=o=>r.value.ssid=o),label:"WIFI名称",placeholder:"请输入WIFI名称",clearable:""},null,8,["modelValue"]),i(d(O),{modelValue:r.value.password,"onUpdate:modelValue":e[4]||(e[4]=o=>r.value.password=o),type:"password",label:"WIFI密码",placeholder:"请输入WIFI密码",clearable:""},null,8,["modelValue"])]),s("div",ao,[i(d(U),{block:"",round:"",onClick:ge,style:{margin:"0 10px 10px 10px"}},{default:C(()=>e[15]||(e[15]=[D(" 取消 ",-1)])),_:1,__:[15]}),i(d(U),{type:"primary",block:"",round:"",onClick:he,style:{margin:"0 10px 10px 10px"}},{default:C(()=>e[16]||(e[16]=[D(" 确认 ",-1)])),_:1,__:[16]})])])]),_:1},8,["show"]),i(d(A),{show:b.value,"onUpdate:show":e[7]||(e[7]=o=>b.value=o),position:"bottom",style:{height:"80%"},round:""},{default:C(()=>[s("div",io,[s("div",lo,[e[18]||(e[18]=s("h2",null,"通知人管理",-1)),i(d(j),{name:"cross",class:"close-icon",onClick:ye})]),s("div",ro,[s("div",co,[e[19]||(e[19]=s("h3",null,"搜索联系人",-1)),s("div",uo,[i(d(O),{modelValue:I.value,"onUpdate:modelValue":e[6]||(e[6]=o=>I.value=o),placeholder:"通过昵称或手机号搜索",clearable:""},{"right-icon":C(()=>[i(d(j),{name:"search"})]),_:1},8,["modelValue"])])]),s("div",vo,[e[21]||(e[21]=s("h3",null,"已有通知人",-1)),(V(!0),T(R,null,G(E().filter(o=>o.isNotifier),o=>(V(),T("div",{key:o.phone,class:"notifier-item"},[s("div",fo,[s("div",mo,P(o.name),1),s("div",po,P(o.phone),1)]),i(d(U),{size:"small",onClick:c=>K(o.phone)},{default:C(()=>e[20]||(e[20]=[D(" 取消通知 ",-1)])),_:2,__:[20]},1032,["onClick"])]))),128)),E().filter(o=>o.isNotifier).length===0?(V(),T("div",ho," 暂无通知人 ")):M("",!0)]),s("div",go,[e[23]||(e[23]=s("h3",null,"添加新通知人",-1)),(V(!0),T(R,null,G(E().filter(o=>!o.isNotifier),o=>(V(),T("div",{key:o.phone,class:"notifier-item"},[s("div",wo,[s("div",yo,P(o.name),1),s("div",ko,P(o.phone),1)]),i(d(U),{type:"primary",size:"small",onClick:c=>K(o.phone)},{default:C(()=>e[22]||(e[22]=[D(" 添加通知 ",-1)])),_:2,__:[22]},1032,["onClick"])]))),128)),E().filter(o=>!o.isNotifier).length===0?(V(),T("div",bo," 暂无其他联系人 ")):M("",!0)])])])]),_:1},8,["show"]),i(d(A),{show:a.value,"onUpdate:show":e[8]||(e[8]=o=>a.value=o),position:"center",style:{width:"90%",height:"80%",maxWidth:"800px"},round:"",closeable:"",onClickCloseIcon:X,onClickOverlay:X},{default:C(()=>[_.value?(V(),T("div",Io,[i(d(ne),{src:_.value.url,fit:"contain",class:"lightbox-image"},null,8,["src"]),s("div",_o,[s("div",Co,P(_.value.timestamp),1)])])):M("",!0)]),_:1},8,["show"])]))}}),Po=Be(Vo,[["__scopeId","data-v-4da88499"]]);export{Po as default};
