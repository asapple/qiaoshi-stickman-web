import{d as H,v as W,x as L,y as ne,z as Ce,a as i,A as U,L as Ve,C as ie,D as Y,E as Z,r as f,G as xe,H as Pe,J as ze,K as Se,M as $e,O as Te,o as le,Q as ee,R as Ne,S as Le,U as oe,I as j,n as je,c as P,b as s,u as d,N as Ee,w as C,P as A,e as m,F as R,h as G,j as O,B as D,i as F,g as M,t as S,V as te,l as q,p as V,q as De,f as Fe,_ as Ue}from"./index-SM1jagzl.js";import{V as Be}from"./VideoPlayer-BmrD2z30.js";import{G as We,a as Ae}from"./index-kX6-ExLA.js";const[Re,J]=ne("switch"),Ge={size:L,loading:Boolean,disabled:Boolean,modelValue:W,activeColor:String,inactiveColor:String,activeValue:{type:W,default:!0},inactiveValue:{type:W,default:!1}};var Oe=H({name:Re,props:Ge,emits:["change","update:modelValue"],setup(a,{emit:z,slots:l}){const g=()=>a.modelValue===a.activeValue,u=()=>{if(!a.disabled&&!a.loading){const v=g()?a.inactiveValue:a.activeValue;z("update:modelValue",v),z("change",v)}},h=()=>{if(a.loading){const v=g()?a.activeColor:a.inactiveColor;return i(Ve,{class:J("loading"),color:v},null)}if(l.node)return l.node()};return Ce(()=>a.modelValue),()=>{var v;const{size:x,loading:r,disabled:b,activeColor:I,inactiveColor:w}=a,y=g(),p={fontSize:U(x),backgroundColor:y?I:w};return i("div",{role:"switch",class:J({on:y,loading:r,disabled:b}),style:p,tabindex:b?void 0:0,"aria-checked":y,onClick:u},[i("div",{class:J("node")},[h()]),(v=l.background)==null?void 0:v.call(l)])}}});const se=ie(Oe),[Me,$]=ne("image"),qe={src:String,alt:String,fit:String,position:String,round:Boolean,block:Boolean,width:L,height:L,radius:L,lazyLoad:Boolean,iconSize:L,showError:Z,errorIcon:Y("photo-fail"),iconPrefix:String,showLoading:Z,loadingIcon:Y("photo"),crossorigin:String,referrerpolicy:String,decoding:String};var Je=H({name:Me,props:qe,emits:["load","error"],setup(a,{emit:z,slots:l}){const g=f(!1),u=f(!0),h=f(),{$Lazyload:v}=xe().proxy,x=Pe(()=>{const n={width:U(a.width),height:U(a.height)};return ze(a.radius)&&(n.overflow="hidden",n.borderRadius=U(a.radius)),n});Se(()=>a.src,()=>{g.value=!1,u.value=!0});const r=n=>{u.value&&(u.value=!1,z("load",n))},b=()=>{const n=new Event("load");Object.defineProperty(n,"target",{value:h.value,enumerable:!0}),r(n)},I=n=>{g.value=!0,u.value=!1,z("error",n)},w=(n,_,k)=>k?k():i(j,{name:n,size:a.iconSize,class:_,classPrefix:a.iconPrefix},null),y=()=>{if(u.value&&a.showLoading)return i("div",{class:$("loading")},[w(a.loadingIcon,$("loading-icon"),l.loading)]);if(g.value&&a.showError)return i("div",{class:$("error")},[w(a.errorIcon,$("error-icon"),l.error)])},p=()=>{if(g.value||!a.src)return;const n={alt:a.alt,class:$("img"),decoding:a.decoding,style:{objectFit:a.fit,objectPosition:a.position},crossorigin:a.crossorigin,referrerpolicy:a.referrerpolicy};return a.lazyLoad?Ne(i("img",oe({ref:h},n),null),[[Le("lazy"),a.src]]):i("img",oe({ref:h,src:a.src,onLoad:r,onError:I},n),null)},T=({el:n})=>{const _=()=>{n===h.value&&u.value&&b()};h.value?_():ee(_)},N=({el:n})=>{n===h.value&&!g.value&&I()};return v&&$e&&(v.$on("loaded",T),v.$on("error",N),Te(()=>{v.$off("loaded",T),v.$off("error",N)})),le(()=>{ee(()=>{var n;(n=h.value)!=null&&n.complete&&!a.lazyLoad&&b()})}),()=>{var n;return i("div",{class:$({round:a.round,block:a.block}),style:x.value},[p(),y(),(n=l.default)==null?void 0:n.call(l)])}}});const ae=ie(Je),He={class:"device-detail-page"},Qe={class:"device-controls-card"},Ke={class:"control-list"},Xe={class:"control-item"},Ye={class:"control-item"},Ze={class:"exception-images"},eo={class:"image-item"},oo={class:"image-timestamp"},to={class:"wifi-popup"},so={class:"popup-content"},ao={class:"popup-footer"},no={class:"notifier-popup"},io={class:"popup-header"},lo={class:"popup-content"},ro={class:"search-section"},co={class:"search-bar"},uo={class:"notifier-section"},vo={class:"notifier-info"},fo={class:"notifier-name"},ho={class:"notifier-phone"},mo={key:0,class:"empty-state"},po={class:"notifier-section"},go={class:"notifier-info"},wo={class:"notifier-name"},yo={class:"notifier-phone"},ko={key:0,class:"empty-state"},bo={key:0,class:"image-lightbox"},Io={class:"lightbox-info"},_o={class:"image-timestamp"},Co=H({__name:"DeviceDetailView",setup(a){const z=je(),l=z.query.deviceId||"",g=z.query.boxId||"";console.log("deviceId:",l,"boxId:",g);const u=f(""),h=f(!1),v=f(!1),x=f(!1),r=f({ssid:"",password:""}),b=f(!1),I=f(""),w=f([]),y=f([]),p=f({}),T=f([]),N=f([]),n=f(!1),_=f(null),k=()=>localStorage.getItem("authToken")||"",re=async()=>{const t=k();try{const o=await(await fetch(`http://121.40.120.244/realtime/play?deviceId=${l}&protocol=HTTPS_FLV`,{method:"GET",headers:{Authorization:t,"Content-Type":"application/json"}})).json();o.code===200?(p.value=o.data,console.log("获取流地址:",o.data),p.value.wifiName&&(r.value.ssid=p.value.wifiName),p.value.wifiPassword&&(r.value.password=p.value.wifiPassword),p.value?(u.value=p.value.replace(/^http:\/\/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/,"https://asdasdnaoshidhaosi.icu"),console.log("流地址：",u.value)):u.value="https://asdasdnaoshidhaosi.icu/live/stream.live.flv"):m("获取设备信息失败")}catch(e){console.error("请求失败",e),m("网络错误，请重试")}},ce=async()=>{const t=k();try{const o=await(await fetch(`http://121.40.120.244/stickman/warning/box/${g}`,{method:"GET",headers:{Authorization:t,"Content-Type":"application/json"}})).json();o.code===200?(N.value=o.data,T.value=N.value.map(c=>({id:c.id,url:c.combinedImageUrl||c.processedImageUrl||c.imageUrl||"https://picsum.photos/300/200?random=1",timestamp:c.time?new Date(c.time).toLocaleString():""}))):m("获取设备历史异常信息失败")}catch(e){console.error("请求失败",e),m("网络错误，请重试")}},de=async()=>{const t=k();console.log("Token:",t);try{const o=await(await fetch("http://121.40.120.244/stickman/recipient_directory",{method:"GET",headers:{Authorization:t,"Content-Type":"application/json"}})).json();console.log("获取联系人列表:",o),o.code===200?(w.value=o.data,B()):m("获取联系人失败")}catch(e){console.error("请求失败",e),m("网络错误，请重试")}},B=()=>{w.value=w.value.map(t=>({...t,isNotifier:y.value.some(e=>e.phone===t.phone)}))},Q=async t=>{const e=k();try{const c=await(await fetch(`http://121.40.120.244/stickman/recipient?boxId=${t}&page=1&size=10`,{method:"GET",headers:{Authorization:e,"Content-Type":"application/json"}})).json();c.code===200?(console.log(c.data.records),y.value=c.data.records,B()):m("获取设备通知人失败")}catch(o){console.error("请求失败",o),m("网络错误，请重试")}},ue=async t=>{const e=k();try{const c=await(await fetch("http://121.40.120.244/stickman/recipient",{method:"POST",headers:{Authorization:e,"Content-Type":"application/json"},body:JSON.stringify({boxId:parseInt(l),name:t.name,phone:t.phoneNumber})})).json();c.code===200?(console.log(c),q("绑定成功"),await Q(l)):m("绑定失败")}catch{m("网络错误，请重试")}},ve=async t=>{const e=parseInt(y.value[t].id,10),o=k();if(confirm("你确定要解绑这个设备通知人吗？"))try{(await(await fetch(`http://121.40.120.244/stickman/recipient/${e}`,{method:"DELETE",headers:{Authorization:o,"Content-Type":"application/json"}})).json()).code===200?(y.value.splice(t,1),q("解绑成功"),B()):m("解绑失败")}catch{m("请求失败")}},K=async t=>{const e=w.value.find(o=>o.phone===t);if(e)if(e.isNotifier){const o=y.value.findIndex(c=>c.phone===t);o!==-1&&await ve(o)}else await ue(e)},fe=async t=>{const e=k();try{t&&((await(await fetch(`http://121.40.120.244/realtime/inference?deviceId=${l}`,{method:"POST",headers:{Authorization:e,"Content-Type":"application/json"}})).json()).code===200?(h.value=t,u.value=`https://asdasdnaoshidhaosi.icu/inference/${l}.live.flv`,console.log("火柴人url:",u.value)):h.value=!t)}catch(o){h.value=!t,console.error("火柴人模式切换请求失败:",o),m("网络错误，请重试")}finally{Fe()}console.log("火柴人模式状态:",t?"on":"off"),t||(u.value=p.value,console.log("url:",u.value))},he=t=>{v.value=t,console.log("人像隐去状态:",t?"on":"off"),t?(h.value=!0,u.value=`https://asdasdnaoshidhaosi.icu/inference/${l}_hidden.live.flv`,console.log("隐去人像url:",u.value)):u.value=`https://asdasdnaoshidhaosi.icu/inference/${l}.live.flv`},me=()=>{x.value=!0},pe=async()=>{if(!r.value.ssid){te("请输入WIFI名称");return}if(!r.value.password){te("请输入WIFI密码");return}const t=k();try{const o=await(await fetch(`http://121.40.120.244/stickman/box/${l}`,{method:"PUT",headers:{Authorization:t,"Content-Type":"application/json"},body:JSON.stringify({...p.value,wifiName:r.value.ssid,wifiPassword:r.value.password})})).json();o.code===200?(console.log("RES:",o),q("修改设备配置信息成功"),p.value.wifiName=r.value.ssid,p.value.wifiPassword=r.value.password,r.value.ssid="",r.value.password="",x.value=!1):m("修改设备配置信息失败")}catch(e){console.error("请求失败",e),m("网络错误，请重试")}},ge=()=>{r.value.ssid="",r.value.password="",x.value=!1},we=async()=>{b.value=!0,await Q(l),await de()},E=()=>I.value?w.value.filter(t=>t.name.includes(I.value)||t.phone.includes(I.value)):w.value,ye=()=>{b.value=!1},ke=t=>{_.value=t,n.value=!0},X=()=>{n.value=!1,_.value=null},be=()=>{console.log("视频开始播放")},Ie=()=>{console.log("视频已暂停")},_e=t=>{console.error("视频播放错误:",t),m("视频播放失败: "+t)};return le(()=>{console.log("设备详情页加载，设备ID:",l),re(),ce()}),(t,e)=>(V(),P("div",He,[i(d(Ee),{title:"设备详情","left-arrow":"",onClickLeft:e[0]||(e[0]=()=>t.$router.back())}),i(Be,{height:"250px","video-url":u.value,onPlay:be,onPause:Ie,onError:_e},null,8,["video-url"]),s("div",Qe,[e[13]||(e[13]=s("h2",{class:"card-title"},"设备管理",-1)),s("div",Ke,[s("div",Xe,[e[9]||(e[9]=s("span",{class:"control-label"},"火柴人模式",-1)),i(d(se),{modelValue:h.value,"onUpdate:modelValue":e[1]||(e[1]=o=>h.value=o),disabled:v.value,size:"20px",onChange:fe},null,8,["modelValue","disabled"])]),s("div",Ye,[e[10]||(e[10]=s("span",{class:"control-label"},"人像隐去",-1)),i(d(se),{modelValue:v.value,"onUpdate:modelValue":e[2]||(e[2]=o=>v.value=o),size:"20px",onChange:he},null,8,["modelValue"])]),s("div",{class:"control-item action-item",onClick:me},[e[11]||(e[11]=s("span",{class:"control-label"},"配置WIFI",-1)),i(d(j),{name:"arrow"})]),s("div",{class:"control-item action-item",onClick:we},[e[12]||(e[12]=s("span",{class:"control-label"},"通知人管理",-1)),i(d(j),{name:"arrow"})])])]),s("div",Ze,[e[14]||(e[14]=s("h2",{class:"section-title"},"异常事件记录",-1)),i(d(We),{"column-num":2,border:!1,gutter:"10"},{default:C(()=>[(V(!0),P(R,null,G(T.value,o=>(V(),De(d(Ae),{key:o.id,onClick:c=>ke(o)},{default:C(()=>[s("div",eo,[i(d(ae),{src:o.url,width:"100%",height:"100px",fit:"cover",radius:"8"},null,8,["src"]),s("div",oo,S(o.timestamp),1)])]),_:2},1032,["onClick"]))),128))]),_:1})]),i(d(A),{show:x.value,"onUpdate:show":e[5]||(e[5]=o=>x.value=o),position:"bottom",style:{height:"50%"},round:""},{default:C(()=>[s("div",to,[e[17]||(e[17]=s("div",{class:"popup-header"},[s("h2",null,"配置WIFI")],-1)),s("div",so,[i(d(O),{modelValue:r.value.ssid,"onUpdate:modelValue":e[3]||(e[3]=o=>r.value.ssid=o),label:"WIFI名称",placeholder:"请输入WIFI名称",clearable:""},null,8,["modelValue"]),i(d(O),{modelValue:r.value.password,"onUpdate:modelValue":e[4]||(e[4]=o=>r.value.password=o),type:"password",label:"WIFI密码",placeholder:"请输入WIFI密码",clearable:""},null,8,["modelValue"])]),s("div",ao,[i(d(D),{block:"",round:"",onClick:ge,style:{margin:"0 10px 10px 10px"}},{default:C(()=>e[15]||(e[15]=[F(" 取消 ",-1)])),_:1,__:[15]}),i(d(D),{type:"primary",block:"",round:"",onClick:pe,style:{margin:"0 10px 10px 10px"}},{default:C(()=>e[16]||(e[16]=[F(" 确认 ",-1)])),_:1,__:[16]})])])]),_:1},8,["show"]),i(d(A),{show:b.value,"onUpdate:show":e[7]||(e[7]=o=>b.value=o),position:"bottom",style:{height:"80%"},round:""},{default:C(()=>[s("div",no,[s("div",io,[e[18]||(e[18]=s("h2",null,"通知人管理",-1)),i(d(j),{name:"cross",class:"close-icon",onClick:ye})]),s("div",lo,[s("div",ro,[e[19]||(e[19]=s("h3",null,"搜索联系人",-1)),s("div",co,[i(d(O),{modelValue:I.value,"onUpdate:modelValue":e[6]||(e[6]=o=>I.value=o),placeholder:"通过昵称或手机号搜索",clearable:""},{"right-icon":C(()=>[i(d(j),{name:"search"})]),_:1},8,["modelValue"])])]),s("div",uo,[e[21]||(e[21]=s("h3",null,"已有通知人",-1)),(V(!0),P(R,null,G(E().filter(o=>o.isNotifier),o=>(V(),P("div",{key:o.phone,class:"notifier-item"},[s("div",vo,[s("div",fo,S(o.name),1),s("div",ho,S(o.phone),1)]),i(d(D),{size:"small",onClick:c=>K(o.phone)},{default:C(()=>e[20]||(e[20]=[F(" 取消通知 ",-1)])),_:2,__:[20]},1032,["onClick"])]))),128)),E().filter(o=>o.isNotifier).length===0?(V(),P("div",mo," 暂无通知人 ")):M("",!0)]),s("div",po,[e[23]||(e[23]=s("h3",null,"添加新通知人",-1)),(V(!0),P(R,null,G(E().filter(o=>!o.isNotifier),o=>(V(),P("div",{key:o.phone,class:"notifier-item"},[s("div",go,[s("div",wo,S(o.name),1),s("div",yo,S(o.phone),1)]),i(d(D),{type:"primary",size:"small",onClick:c=>K(o.phone)},{default:C(()=>e[22]||(e[22]=[F(" 添加通知 ",-1)])),_:2,__:[22]},1032,["onClick"])]))),128)),E().filter(o=>!o.isNotifier).length===0?(V(),P("div",ko," 暂无其他联系人 ")):M("",!0)])])])]),_:1},8,["show"]),i(d(A),{show:n.value,"onUpdate:show":e[8]||(e[8]=o=>n.value=o),position:"center",style:{width:"90%",height:"80%",maxWidth:"800px"},round:"",closeable:"",onClickCloseIcon:X,onClickOverlay:X},{default:C(()=>[_.value?(V(),P("div",bo,[i(d(ae),{src:_.value.url,fit:"contain",class:"lightbox-image"},null,8,["src"]),s("div",Io,[s("div",_o,S(_.value.timestamp),1)])])):M("",!0)]),_:1},8,["show"])]))}}),So=Ue(Co,[["__scopeId","data-v-f5d72ff6"]]);export{So as default};
