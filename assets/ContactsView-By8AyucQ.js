import{d as L,r as c,o as R,c as y,a as n,b as r,w as s,u as l,N as q,g as D,j as k,a8 as N,P as O,T as J,e as i,I as w,B as b,i as p,F as A,h as I,t as K,k as V,l as T,s as M,f as H,p as f,q as S,a9 as z,_ as Q}from"./index-BGgQ4qsW.js";const W={class:"contacts-page"},X={class:"search-section"},Y={class:"search-box"},Z={key:0,class:"search-results"},ee={class:"contacts-section"},oe={class:"add-contact-popup"},te={class:"popup-content"},ae={class:"popup-footer"},le=L({__name:"ContactsView",setup(ne){const h=c([]),v=c(""),_=c([]),g=c(!1),a=c({name:"",phone:"",code:""}),m=c(!1),u=c(0),C=()=>localStorage.getItem("authToken")||"",x=async()=>{try{const t=C(),o=await(await fetch("http://121.40.120.244:8080/stickman/recipient_directory",{method:"GET",headers:{Authorization:t}})).json();o.code===200?h.value=o.data.map(d=>({id:d.recipientId,name:d.name,phone:d.phoneNumber})):i(o.message||"获取联系人失败")}catch(t){i("网络错误"),console.error("Failed to fetch contacts:",t)}},B=()=>{if(!v.value){i("请输入搜索关键词");return}_.value=h.value.filter(t=>t.name.includes(v.value)||t.phone.includes(v.value)),_.value.length===0&&i("未找到匹配的联系人")},$=async t=>{try{const e=C(),d=await(await fetch(`http://121.40.120.244:8080/stickman/recipient_directory/${t}`,{method:"DELETE",headers:{Authorization:e}})).json();d.code===200?(h.value=h.value.filter(G=>G.id!==t),T("联系人已删除")):i(d.message||"删除失败")}catch(e){i("网络错误"),console.error("Failed to delete contact:",e)}},E=()=>{g.value=!0},F=()=>{if(console.log("Sending verification code..."),!a.value.phone){i("请输入手机号");return}if(!/^1[3-9]\d{9}$/.test(a.value.phone)){i("请输入正确的手机号");return}if(m.value||u.value>0){console.log("Code sending is in cooldown period");return}m.value=!0,fetch(`http://121.40.120.244:8080/stickman/recipient_directory/verification_code?phone=${a.value.phone}`,{method:"GET",headers:{Authorization:C()}}).then(t=>t.json()).then(t=>{console.log("Verification code response:",t),t.code===200?(T("验证码已发送"),j()):(i(t.message||"发送失败，请重试"),m.value=!1)}).catch(t=>{console.error("Error sending code:",t),i("网络错误，请重试"),m.value=!1})},j=()=>{u.value=60;const t=setInterval(()=>{u.value--,u.value<=0&&(clearInterval(t),m.value=!1)},1e3)},U=async()=>{if(console.log("Attempting to add contact..."),console.log("Contact data:",a.value),!a.value.name){i("请输入昵称"),console.log("Validation failed: name is empty");return}if(!a.value.phone){i("请输入手机号"),console.log("Validation failed: phone is empty");return}if(!a.value.code){i("请输入验证码"),console.log("Validation failed: code is empty");return}try{M("添加中...");const t=C();console.log("Sending request with token:",t);const e=await fetch("http://121.40.120.244:8080/stickman/recipient_directory",{method:"POST",headers:{Authorization:t,"Content-Type":"application/json"},body:JSON.stringify({name:a.value.name,phoneNumber:a.value.phone,verificationCode:a.value.code})});console.log("Response received:",e);const o=await e.json();console.log("Result:",o),o.code===200?(T("联系人添加成功"),await x(),a.value.name="",a.value.phone="",a.value.code="",g.value=!1):i(o.message||"添加失败")}catch(t){i("网络错误，请稍后重试"),console.error("Failed to add contact:",t)}finally{H()}},P=()=>{a.value.name="",a.value.phone="",a.value.code="",g.value=!1};return R(()=>{x()}),(t,e)=>(f(),y("div",W,[n(l(q),{title:"通知人管理"},{right:s(()=>[n(l(w),{name:"plus",size:"20",onClick:E})]),_:1}),r("div",X,[e[6]||(e[6]=r("div",{class:"section-title"},"搜索通知人",-1)),r("div",Y,[n(l(k),{modelValue:v.value,"onUpdate:modelValue":e[0]||(e[0]=o=>v.value=o),placeholder:"请输入手机号或昵称",clearable:""},{button:s(()=>[n(l(b),{size:"small",type:"primary",onClick:B},{default:s(()=>e[5]||(e[5]=[p("搜索",-1)])),_:1,__:[5]})]),_:1},8,["modelValue"])]),v.value&&_.value.length>0?(f(),y("div",Z,[n(l(N),null,{default:s(()=>[(f(!0),y(A,null,I(_.value,o=>(f(),S(l(z),{key:o.id,title:o.name,label:o.phone},{"right-icon":s(()=>[n(l(w),{name:"delete-o",onClick:d=>$(o.id)},null,8,["onClick"])]),_:2},1032,["title","label"]))),128))]),_:1})])):D("",!0)]),r("div",ee,[e[7]||(e[7]=r("div",{class:"section-title"},"联系人列表",-1)),n(l(N),null,{default:s(()=>[(f(!0),y(A,null,I(h.value,o=>(f(),S(l(z),{key:o.id,title:o.name,label:o.phone},{"right-icon":s(()=>[n(l(w),{name:"delete-o",onClick:d=>$(o.id)},null,8,["onClick"])]),_:2},1032,["title","label"]))),128))]),_:1})]),n(l(O),{show:g.value,"onUpdate:show":e[4]||(e[4]=o=>g.value=o),position:"bottom",style:{height:"50%"},round:""},{default:s(()=>[r("div",oe,[e[10]||(e[10]=r("div",{class:"popup-header"},[r("h2",null,"添加新联系人")],-1)),r("div",te,[n(l(k),{modelValue:a.value.name,"onUpdate:modelValue":e[1]||(e[1]=o=>a.value.name=o),label:"昵称",placeholder:"请输入昵称",clearable:""},null,8,["modelValue"]),n(l(k),{modelValue:a.value.phone,"onUpdate:modelValue":e[2]||(e[2]=o=>a.value.phone=o),label:"手机号",placeholder:"请输入手机号",clearable:"",type:"tel"},null,8,["modelValue"]),n(l(k),{modelValue:a.value.code,"onUpdate:modelValue":e[3]||(e[3]=o=>a.value.code=o),label:"验证码",placeholder:"请输入验证码",clearable:""},{button:s(()=>[n(l(b),{size:"small",onClick:F,disabled:m.value||u.value>0},{default:s(()=>[p(K(u.value>0?`${u.value}秒后重发`:"发送"),1)]),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),r("div",ae,[n(l(b),{block:"",round:"",onClick:P,style:{margin:"0 10px 10px 10px"}},{default:s(()=>e[8]||(e[8]=[p(" 取消 ",-1)])),_:1,__:[8]}),n(l(b),{type:"primary",block:"",round:"",onClick:U,style:{margin:"0 10px 10px 10px"}},{default:s(()=>e[9]||(e[9]=[p(" 添加 ",-1)])),_:1,__:[9]})])])]),_:1},8,["show"]),n(l(J),{route:""},{default:s(()=>[n(l(V),{replace:"",to:"/device",icon:"apps-o"},{default:s(()=>e[11]||(e[11]=[p("设备",-1)])),_:1,__:[11]}),n(l(V),{replace:"",to:"/contacts",icon:"contact-o"},{default:s(()=>e[12]||(e[12]=[p("通知人",-1)])),_:1,__:[12]}),n(l(V),{replace:"",to:"/profile",icon:"user-o"},{default:s(()=>e[13]||(e[13]=[p("我的",-1)])),_:1,__:[13]})]),_:1})]))}}),ie=Q(le,[["__scopeId","data-v-0e1f6e07"]]);export{ie as default};
