import{d as H,v as W,x as $,y as ae,z as be,a as i,A as U,L as Ie,C as ne,D as Y,E as Z,r as m,G as _e,H as Ce,J as xe,K as Ve,M as Pe,O as Te,o as ie,Q as ee,R as ze,S as Se,U as oe,I as L,n as Ne,c as x,b as s,u as c,N as $e,w as I,P as R,e as h,F as A,h as G,j as O,B as D,i as F,g as M,t as z,V as te,l as q,p as _,q as Le,_ as Ee}from"./index-B74mSwrR.js";import{V as je}from"./VideoPlayer-BizLPRdA.js";import{G as De,a as Fe}from"./index-BAdLfWy-.js";const[Ue,J]=ae("switch"),Be={size:$,loading:Boolean,disabled:Boolean,modelValue:W,activeColor:String,inactiveColor:String,activeValue:{type:W,default:!0},inactiveValue:{type:W,default:!1}};var We=H({name:Ue,props:Be,emits:["change","update:modelValue"],setup(t,{emit:V,slots:u}){const g=()=>t.modelValue===t.activeValue,f=()=>{if(!t.disabled&&!t.loading){const d=g()?t.inactiveValue:t.activeValue;V("update:modelValue",d),V("change",d)}},p=()=>{if(t.loading){const d=g()?t.activeColor:t.inactiveColor;return i(Ie,{class:J("loading"),color:d},null)}if(u.node)return u.node()};return be(()=>t.modelValue),()=>{var d;const{size:l,loading:C,disabled:y,activeColor:k,inactiveColor:b}=t,v=g(),T={fontSize:U(l),backgroundColor:v?k:b};return i("div",{role:"switch",class:J({on:v,loading:C,disabled:y}),style:T,tabindex:y?void 0:0,"aria-checked":v,onClick:f},[i("div",{class:J("node")},[p()]),(d=u.background)==null?void 0:d.call(u)])}}});const Re=ne(We),[Ae,S]=ae("image"),Ge={src:String,alt:String,fit:String,position:String,round:Boolean,block:Boolean,width:$,height:$,radius:$,lazyLoad:Boolean,iconSize:$,showError:Z,errorIcon:Y("photo-fail"),iconPrefix:String,showLoading:Z,loadingIcon:Y("photo"),crossorigin:String,referrerpolicy:String,decoding:String};var Oe=H({name:Ae,props:Ge,emits:["load","error"],setup(t,{emit:V,slots:u}){const g=m(!1),f=m(!0),p=m(),{$Lazyload:d}=_e().proxy,l=Ce(()=>{const n={width:U(t.width),height:U(t.height)};return xe(t.radius)&&(n.overflow="hidden",n.borderRadius=U(t.radius)),n});Ve(()=>t.src,()=>{g.value=!1,f.value=!0});const C=n=>{f.value&&(f.value=!1,V("load",n))},y=()=>{const n=new Event("load");Object.defineProperty(n,"target",{value:p.value,enumerable:!0}),C(n)},k=n=>{g.value=!0,f.value=!1,V("error",n)},b=(n,w,E)=>E?E():i(L,{name:n,size:t.iconSize,class:w,classPrefix:t.iconPrefix},null),v=()=>{if(f.value&&t.showLoading)return i("div",{class:S("loading")},[b(t.loadingIcon,S("loading-icon"),u.loading)]);if(g.value&&t.showError)return i("div",{class:S("error")},[b(t.errorIcon,S("error-icon"),u.error)])},T=()=>{if(g.value||!t.src)return;const n={alt:t.alt,class:S("img"),decoding:t.decoding,style:{objectFit:t.fit,objectPosition:t.position},crossorigin:t.crossorigin,referrerpolicy:t.referrerpolicy};return t.lazyLoad?ze(i("img",oe({ref:p},n),null),[[Se("lazy"),t.src]]):i("img",oe({ref:p,src:t.src,onLoad:C,onError:k},n),null)},N=({el:n})=>{const w=()=>{n===p.value&&f.value&&y()};p.value?w():ee(w)},P=({el:n})=>{n===p.value&&!g.value&&k()};return d&&Pe&&(d.$on("loaded",N),d.$on("error",P),Te(()=>{d.$off("loaded",N),d.$off("error",P)})),ie(()=>{ee(()=>{var n;(n=p.value)!=null&&n.complete&&!t.lazyLoad&&y()})}),()=>{var n;return i("div",{class:S({round:t.round,block:t.block}),style:l.value},[T(),v(),(n=u.default)==null?void 0:n.call(u)])}}});const se=ne(Oe),Me={class:"device-detail-page"},qe={class:"device-controls-card"},Je={class:"control-list"},He={class:"control-item"},Qe={class:"exception-images"},Ke={class:"image-item"},Xe={class:"image-timestamp"},Ye={class:"wifi-popup"},Ze={class:"popup-content"},eo={class:"popup-footer"},oo={class:"notifier-popup"},to={class:"popup-header"},so={class:"popup-content"},ao={class:"search-section"},no={class:"search-bar"},io={class:"notifier-section"},lo={class:"notifier-info"},ro={class:"notifier-name"},co={class:"notifier-phone"},uo={key:0,class:"empty-state"},vo={class:"notifier-section"},fo={class:"notifier-info"},mo={class:"notifier-name"},ho={class:"notifier-phone"},po={key:0,class:"empty-state"},go={key:0,class:"image-lightbox"},wo={class:"lightbox-info"},yo={class:"image-timestamp"},ko=H({__name:"DeviceDetailView",setup(t){const V=Ne(),u=V.query.deviceId||"",g=V.query.boxId||"";console.log("deviceId:",u,"boxId:",g);const f=m(""),p=m(!1),d=m(!1),l=m({ssid:"",password:""}),C=m(!1),y=m(""),k=m([]),b=m([]),v=m({}),T=m([]),N=m([]),P=m(!1),n=m(null),w=()=>localStorage.getItem("authToken")||"",E=async()=>{const a=w();try{const o=await(await fetch(`http://121.40.120.244:8080/realtime/play?deviceId=${u}&protocol=HTTPS_FLV`,{method:"GET",headers:{Authorization:a,"Content-Type":"application/json"}})).json();o.code===200?(v.value=o.data,console.log("获取流地址:",o.data),v.value.wifiName&&(l.value.ssid=v.value.wifiName),v.value.wifiPassword&&(l.value.password=v.value.wifiPassword),v.value?setTimeout(()=>{f.value=v.value,console.log("流地址：",f.value)},2e3):setTimeout(()=>{f.value="https://47.118.84.20/live/stream.live.flv"},2e3)):h("获取设备信息失败")}catch(e){console.error("请求失败",e),h("网络错误，请重试")}},le=async()=>{const a=w();try{const o=await(await fetch(`http://121.40.120.244:8080/stickman/warning/box/${g}`,{method:"GET",headers:{Authorization:a,"Content-Type":"application/json"}})).json();o.code===200?(N.value=o.data,T.value=N.value.map(r=>({id:r.id,url:r.combinedImageUrl||r.processedImageUrl||r.imageUrl||"https://picsum.photos/300/200?random=1",timestamp:r.time?new Date(r.time).toLocaleString():""}))):h("获取设备历史异常信息失败")}catch(e){console.error("请求失败",e),h("网络错误，请重试")}},re=async()=>{const a=w();console.log("Token:",a);try{const o=await(await fetch("http://121.40.120.244:8080/stickman/recipient_directory",{method:"GET",headers:{Authorization:a,"Content-Type":"application/json"}})).json();console.log("获取联系人列表:",o),o.code===200?(k.value=o.data,B()):h("获取联系人失败")}catch(e){console.error("请求失败",e),h("网络错误，请重试")}},B=()=>{k.value=k.value.map(a=>({...a,isNotifier:b.value.some(e=>e.phone===a.phone)}))},Q=async a=>{const e=w();try{const r=await(await fetch(`http://121.40.120.244:8080/stickman/recipient?boxId=${a}&page=1&size=10`,{method:"GET",headers:{Authorization:e,"Content-Type":"application/json"}})).json();r.code===200?(console.log(r.data.records),b.value=r.data.records,B()):h("获取设备通知人失败")}catch(o){console.error("请求失败",o),h("网络错误，请重试")}},ce=async a=>{const e=w();try{const r=await(await fetch("http://121.40.120.244:8080/stickman/recipient",{method:"POST",headers:{Authorization:e,"Content-Type":"application/json"},body:JSON.stringify({boxId:parseInt(u),name:a.name,phone:a.phoneNumber})})).json();r.code===200?(console.log(r),q("绑定成功"),await Q(u)):h("绑定失败")}catch{h("网络错误，请重试")}},de=async a=>{const e=parseInt(b.value[a].id,10),o=w();if(confirm("你确定要解绑这个设备通知人吗？"))try{(await(await fetch(`http://121.40.120.244:8080/stickman/recipient/${e}`,{method:"DELETE",headers:{Authorization:o,"Content-Type":"application/json"}})).json()).code===200?(b.value.splice(a,1),q("解绑成功"),B()):h("解绑失败")}catch{h("请求失败")}},K=async a=>{const e=k.value.find(o=>o.phone===a);if(e)if(e.isNotifier){const o=b.value.findIndex(r=>r.phone===a);o!==-1&&await de(o)}else await ce(e)},ue=a=>{if(p.value=a,console.log("隐去人像状态:",a?"on":"off"),a){const e=`https://47.118.84.20:443/inference/${u}_hidden.live.flv`;console.log("隐去人像url:",e),setTimeout(()=>{f.value=e},3e3)}else console.log("切换到原视频"),setTimeout(()=>{f.value=v.value,console.log("原视频url:",f.value)},2e3)},ve=()=>{d.value=!0},fe=async()=>{if(!l.value.ssid){te("请输入WIFI名称");return}if(!l.value.password){te("请输入WIFI密码");return}const a=w();try{const o=await(await fetch(`http://121.40.120.244:8080/stickman/box/${u}`,{method:"PUT",headers:{Authorization:a,"Content-Type":"application/json"},body:JSON.stringify({...v.value,wifiName:l.value.ssid,wifiPassword:l.value.password})})).json();o.code===200?(console.log("RES:",o),q("修改设备配置信息成功"),v.value.wifiName=l.value.ssid,v.value.wifiPassword=l.value.password,l.value.ssid="",l.value.password="",d.value=!1):h("修改设备配置信息失败")}catch(e){console.error("请求失败",e),h("网络错误，请重试")}},me=()=>{l.value.ssid="",l.value.password="",d.value=!1},he=async()=>{C.value=!0,await Q(u),await re()},j=()=>y.value?k.value.filter(a=>a.name.includes(y.value)||a.phone.includes(y.value)):k.value,pe=()=>{C.value=!1},ge=a=>{n.value=a,P.value=!0},X=()=>{P.value=!1,n.value=null},we=()=>{console.log("视频开始播放")},ye=()=>{console.log("视频已暂停")},ke=a=>{console.error("视频播放错误:",a),h("视频播放失败: "+a)};return ie(()=>{console.log("设备详情页加载，设备ID:",u),E(),le()}),(a,e)=>(_(),x("div",Me,[i(c($e),{title:"设备详情","left-arrow":"",onClickLeft:e[0]||(e[0]=()=>a.$router.back())}),i(je,{height:"250px","video-url":f.value,onPlay:we,onPause:ye,onError:ke},null,8,["video-url"]),s("div",qe,[e[11]||(e[11]=s("h2",{class:"card-title"},"设备管理",-1)),s("div",Je,[s("div",He,[e[8]||(e[8]=s("span",{class:"control-label"},"隐去人像",-1)),i(c(Re),{modelValue:p.value,"onUpdate:modelValue":e[1]||(e[1]=o=>p.value=o),size:"20px",onChange:ue},null,8,["modelValue"])]),s("div",{class:"control-item action-item",onClick:ve},[e[9]||(e[9]=s("span",{class:"control-label"},"配置WIFI",-1)),i(c(L),{name:"arrow"})]),s("div",{class:"control-item action-item",onClick:he},[e[10]||(e[10]=s("span",{class:"control-label"},"通知人管理",-1)),i(c(L),{name:"arrow"})])])]),s("div",Qe,[e[12]||(e[12]=s("h2",{class:"section-title"},"异常事件记录",-1)),i(c(De),{"column-num":2,border:!1,gutter:"10"},{default:I(()=>[(_(!0),x(A,null,G(T.value,o=>(_(),Le(c(Fe),{key:o.id,onClick:r=>ge(o)},{default:I(()=>[s("div",Ke,[i(c(se),{src:o.url,width:"100%",height:"100px",fit:"cover",radius:"8"},null,8,["src"]),s("div",Xe,z(o.timestamp),1)])]),_:2},1032,["onClick"]))),128))]),_:1})]),i(c(R),{show:d.value,"onUpdate:show":e[4]||(e[4]=o=>d.value=o),position:"bottom",style:{height:"50%"},round:""},{default:I(()=>[s("div",Ye,[e[15]||(e[15]=s("div",{class:"popup-header"},[s("h2",null,"配置WIFI")],-1)),s("div",Ze,[i(c(O),{modelValue:l.value.ssid,"onUpdate:modelValue":e[2]||(e[2]=o=>l.value.ssid=o),label:"WIFI名称",placeholder:"请输入WIFI名称",clearable:""},null,8,["modelValue"]),i(c(O),{modelValue:l.value.password,"onUpdate:modelValue":e[3]||(e[3]=o=>l.value.password=o),type:"password",label:"WIFI密码",placeholder:"请输入WIFI密码",clearable:""},null,8,["modelValue"])]),s("div",eo,[i(c(D),{block:"",round:"",onClick:me,style:{margin:"0 10px 10px 10px"}},{default:I(()=>e[13]||(e[13]=[F(" 取消 ",-1)])),_:1,__:[13]}),i(c(D),{type:"primary",block:"",round:"",onClick:fe,style:{margin:"0 10px 10px 10px"}},{default:I(()=>e[14]||(e[14]=[F(" 确认 ",-1)])),_:1,__:[14]})])])]),_:1},8,["show"]),i(c(R),{show:C.value,"onUpdate:show":e[6]||(e[6]=o=>C.value=o),position:"bottom",style:{height:"80%"},round:""},{default:I(()=>[s("div",oo,[s("div",to,[e[16]||(e[16]=s("h2",null,"通知人管理",-1)),i(c(L),{name:"cross",class:"close-icon",onClick:pe})]),s("div",so,[s("div",ao,[e[17]||(e[17]=s("h3",null,"搜索联系人",-1)),s("div",no,[i(c(O),{modelValue:y.value,"onUpdate:modelValue":e[5]||(e[5]=o=>y.value=o),placeholder:"通过昵称或手机号搜索",clearable:""},{"right-icon":I(()=>[i(c(L),{name:"search"})]),_:1},8,["modelValue"])])]),s("div",io,[e[19]||(e[19]=s("h3",null,"已有通知人",-1)),(_(!0),x(A,null,G(j().filter(o=>o.isNotifier),o=>(_(),x("div",{key:o.phone,class:"notifier-item"},[s("div",lo,[s("div",ro,z(o.name),1),s("div",co,z(o.phone),1)]),i(c(D),{size:"small",onClick:r=>K(o.phone)},{default:I(()=>e[18]||(e[18]=[F(" 取消通知 ",-1)])),_:2,__:[18]},1032,["onClick"])]))),128)),j().filter(o=>o.isNotifier).length===0?(_(),x("div",uo," 暂无通知人 ")):M("",!0)]),s("div",vo,[e[21]||(e[21]=s("h3",null,"添加新通知人",-1)),(_(!0),x(A,null,G(j().filter(o=>!o.isNotifier),o=>(_(),x("div",{key:o.phone,class:"notifier-item"},[s("div",fo,[s("div",mo,z(o.name),1),s("div",ho,z(o.phone),1)]),i(c(D),{type:"primary",size:"small",onClick:r=>K(o.phone)},{default:I(()=>e[20]||(e[20]=[F(" 添加通知 ",-1)])),_:2,__:[20]},1032,["onClick"])]))),128)),j().filter(o=>!o.isNotifier).length===0?(_(),x("div",po," 暂无其他联系人 ")):M("",!0)])])])]),_:1},8,["show"]),i(c(R),{show:P.value,"onUpdate:show":e[7]||(e[7]=o=>P.value=o),position:"center",style:{width:"90%",height:"80%",maxWidth:"800px"},round:"",closeable:"",onClickCloseIcon:X,onClickOverlay:X},{default:I(()=>[n.value?(_(),x("div",go,[i(c(se),{src:n.value.url,fit:"contain",class:"lightbox-image"},null,8,["src"]),s("div",wo,[s("div",yo,z(n.value.timestamp),1)])])):M("",!0)]),_:1},8,["show"])]))}}),xo=Ee(ko,[["__scopeId","data-v-b6b2ecef"]]);export{xo as default};
