import{d as U,v as B,x as P,y as ne,z as ke,a as l,A as R,L as be,C as le,D as Z,E as ee,r as f,G as _e,H as Ie,J as Ce,K as xe,M as Ve,O as ze,o as Q,Q as oe,R as Se,S as Ne,U as te,I as T,V as $e,c as C,q as Le,b as t,n as y,_ as re,W as Pe,u as c,N as Te,w as I,P as A,e as p,F as G,h as M,j as O,B as D,i as F,g as H,t as $,X as se,l as J,p as Ee}from"./index-kUOXs0hd.js";import{G as je,a as De}from"./index-DZ7w8ydf.js";const[Fe,q]=ne("switch"),Re={size:P,loading:Boolean,disabled:Boolean,modelValue:B,activeColor:String,inactiveColor:String,activeValue:{type:B,default:!0},inactiveValue:{type:B,default:!1}};var Ue=U({name:Fe,props:Re,emits:["change","update:modelValue"],setup(s,{emit:w,slots:d}){const v=()=>s.modelValue===s.activeValue,m=()=>{if(!s.disabled&&!s.loading){const i=v()?s.inactiveValue:s.activeValue;w("update:modelValue",i),w("change",i)}},u=()=>{if(s.loading){const i=v()?s.activeColor:s.inactiveColor;return l(be,{class:q("loading"),color:i},null)}if(d.node)return d.node()};return ke(()=>s.modelValue),()=>{var i;const{size:k,loading:b,disabled:g,activeColor:_,inactiveColor:h}=s,x=v(),S={fontSize:R(k),backgroundColor:x?_:h};return l("div",{role:"switch",class:q({on:x,loading:b,disabled:g}),style:S,tabindex:g?void 0:0,"aria-checked":x,onClick:m},[l("div",{class:q("node")},[u()]),(i=d.background)==null?void 0:i.call(d)])}}});const ae=le(Ue),[We,L]=ne("image"),Be={src:String,alt:String,fit:String,position:String,round:Boolean,block:Boolean,width:P,height:P,radius:P,lazyLoad:Boolean,iconSize:P,showError:ee,errorIcon:Z("photo-fail"),iconPrefix:String,showLoading:ee,loadingIcon:Z("photo"),crossorigin:String,referrerpolicy:String,decoding:String};var Ae=U({name:We,props:Be,emits:["load","error"],setup(s,{emit:w,slots:d}){const v=f(!1),m=f(!0),u=f(),{$Lazyload:i}=_e().proxy,k=Ie(()=>{const n={width:R(s.width),height:R(s.height)};return Ce(s.radius)&&(n.overflow="hidden",n.borderRadius=R(s.radius)),n});xe(()=>s.src,()=>{v.value=!1,m.value=!0});const b=n=>{m.value&&(m.value=!1,w("load",n))},g=()=>{const n=new Event("load");Object.defineProperty(n,"target",{value:u.value,enumerable:!0}),b(n)},_=n=>{v.value=!0,m.value=!1,w("error",n)},h=(n,N,E)=>E?E():l(T,{name:n,size:s.iconSize,class:N,classPrefix:s.iconPrefix},null),x=()=>{if(m.value&&s.showLoading)return l("div",{class:L("loading")},[h(s.loadingIcon,L("loading-icon"),d.loading)]);if(v.value&&s.showError)return l("div",{class:L("error")},[h(s.errorIcon,L("error-icon"),d.error)])},S=()=>{if(v.value||!s.src)return;const n={alt:s.alt,class:L("img"),decoding:s.decoding,style:{objectFit:s.fit,objectPosition:s.position},crossorigin:s.crossorigin,referrerpolicy:s.referrerpolicy};return s.lazyLoad?Se(l("img",te({ref:u},n),null),[[Ne("lazy"),s.src]]):l("img",te({ref:u,src:s.src,onLoad:b,onError:_},n),null)},z=({el:n})=>{const N=()=>{n===u.value&&m.value&&g()};u.value?N():oe(N)},V=({el:n})=>{n===u.value&&!v.value&&_()};return i&&Ve&&(i.$on("loaded",z),i.$on("error",V),ze(()=>{i.$off("loaded",z),i.$off("error",V)})),Q(()=>{oe(()=>{var n;(n=u.value)!=null&&n.complete&&!s.lazyLoad&&g()})}),()=>{var n;return l("div",{class:L({round:s.round,block:s.block}),style:k.value},[S(),x(),(n=d.default)==null?void 0:n.call(d)])}}});const ie=le(Ae),Ge=U({__name:"VideoPlayer",props:{height:{type:String,default:"250px"},aspectRatio:{type:String,default:"16:9"}},setup(s){const w=s,d=f(w.height),v=()=>{if(w.aspectRatio&&w.aspectRatio.includes(":")){const[m,u]=w.aspectRatio.split(":").map(Number),i=document.querySelector(".video-player");if(i){const k=i.clientWidth;d.value=`${k*u/m}px`}}};return Q(()=>{v(),window.addEventListener("resize",v)}),$e(()=>{window.removeEventListener("resize",v)}),(m,u)=>(y(),C("div",{class:"video-player",style:Le({height:d.value})},u[0]||(u[0]=[t("div",{class:"video-placeholder"},[t("div",{class:"play-icon"},"▶"),t("div",{class:"video-text"},"实时视频播放区域")],-1)]),4))}}),Me=re(Ge,[["__scopeId","data-v-0fba4730"]]),Oe={class:"device-detail-page"},He={class:"device-controls-card"},Je={class:"control-list"},qe={class:"control-item"},Qe={class:"control-item"},Ke={class:"exception-images"},Xe={class:"image-item"},Ye={class:"image-timestamp"},Ze={class:"wifi-popup"},eo={class:"popup-content"},oo={class:"popup-footer"},to={class:"notifier-popup"},so={class:"popup-header"},ao={class:"popup-content"},io={class:"search-section"},no={class:"search-bar"},lo={class:"notifier-section"},ro={class:"notifier-info"},co={class:"notifier-name"},uo={class:"notifier-phone"},vo={key:0,class:"empty-state"},fo={class:"notifier-section"},mo={class:"notifier-info"},po={class:"notifier-name"},ho={class:"notifier-phone"},go={key:0,class:"empty-state"},wo={key:0,class:"image-lightbox"},yo={class:"lightbox-info"},ko={class:"image-timestamp"},bo=U({__name:"DeviceDetailView",setup(s){const d=Pe().params.id||"1",v=f(!1),m=f(!1),u=f(!1),i=f({ssid:"",password:""}),k=f(!1),b=f(""),g=f([]),_=f([]),h=f({}),x=f([]),S=f([]),z=f(!1),V=f(null),n=()=>localStorage.getItem("authToken")||"",N=async()=>{const a=n();try{const o=await(await fetch(`http://121.40.120.244/stickman/box/${d}`,{method:"GET",headers:{Authorization:a,"Content-Type":"application/json"}})).json();o.code===200?(h.value=o.data,h.value.wifiName&&(i.value.ssid=h.value.wifiName),h.value.wifiPassword&&(i.value.password=h.value.wifiPassword)):p(o.message||"获取设备信息失败")}catch(e){console.error("请求失败",e),p("网络错误，请重试")}},E=async()=>{const a=n();try{const o=await(await fetch(`http://121.40.120.244/stickman/warning/box/${d}`,{method:"GET",headers:{Authorization:a,"Content-Type":"application/json"}})).json();o.code===200?(S.value=o.data,x.value=S.value.map(r=>({id:r.id,url:r.combinedImageUrl||r.processedImageUrl||r.imageUrl||"https://picsum.photos/300/200?random=1",timestamp:r.time?new Date(r.time).toLocaleString():""}))):p(o.message||"获取设备历史异常信息失败")}catch(e){console.error("请求失败",e),p("网络错误，请重试")}},ce=async()=>{const a=n();console.log("Token:",a);try{const o=await(await fetch("http://121.40.120.244/stickman/recipient_directory",{method:"GET",headers:{Authorization:a,"Content-Type":"application/json"}})).json();console.log("获取联系人列表:",o),o.code===200?(g.value=o.data,W()):p(o.message||"获取联系人失败")}catch(e){console.error("请求失败",e),p("网络错误，请重试")}},W=()=>{g.value=g.value.map(a=>({...a,isNotifier:_.value.some(e=>e.phone===a.phone)}))},K=async a=>{const e=n();try{const r=await(await fetch(`http://121.40.120.244/stickman/recipient?boxId=${a}&page=1&size=10`,{method:"GET",headers:{Authorization:e,"Content-Type":"application/json"}})).json();r.code===200?(console.log(r.data.records),_.value=r.data.records,W()):p(r.message||"获取设备通知人失败")}catch(o){console.error("请求失败",o),p("网络错误，请重试")}},de=async a=>{const e=n();try{const r=await(await fetch("http://121.40.120.244/stickman/recipient",{method:"POST",headers:{Authorization:e,"Content-Type":"application/json"},body:JSON.stringify({boxId:parseInt(d),name:a.name,phone:a.phoneNumber})})).json();r.code===200?(console.log(r),J("绑定成功"),await K(d)):p(r.message||"绑定失败")}catch{p("网络错误，请重试")}},ue=async a=>{const e=parseInt(_.value[a].id,10),o=n();if(confirm("你确定要解绑这个设备通知人吗？"))try{(await(await fetch(`http://121.40.120.244/stickman/recipient/${e}`,{method:"DELETE",headers:{Authorization:o,"Content-Type":"application/json"}})).json()).code===200?(_.value.splice(a,1),J("解绑成功"),W()):p("解绑失败")}catch{p("请求失败")}},X=async a=>{const e=g.value.find(o=>o.phone===a);if(e)if(e.isNotifier){const o=_.value.findIndex(r=>r.phone===a);o!==-1&&await ue(o)}else await de(e)},ve=a=>{v.value=a,console.log("火柴人模式状态:",a?"on":"off")},fe=a=>{m.value=a,console.log("人像隐去状态:",a?"on":"off"),a&&!v.value&&(v.value=!0)},me=()=>{u.value=!0},pe=async()=>{if(!i.value.ssid){se("请输入WIFI名称");return}if(!i.value.password){se("请输入WIFI密码");return}const a=n();try{const o=await(await fetch(`http://121.40.120.244/stickman/box/${d}`,{method:"PUT",headers:{Authorization:a,"Content-Type":"application/json"},body:JSON.stringify({...h.value,wifiName:i.value.ssid,wifiPassword:i.value.password})})).json();o.code===200?(console.log("RES:",o),J("修改设备配置信息成功"),h.value.wifiName=i.value.ssid,h.value.wifiPassword=i.value.password,i.value.ssid="",i.value.password="",u.value=!1):p(o.message||"修改设备配置信息失败")}catch(e){console.error("请求失败",e),p("网络错误，请重试")}},he=()=>{i.value.ssid="",i.value.password="",u.value=!1},ge=async()=>{k.value=!0,await K(d),await ce()},j=()=>b.value?g.value.filter(a=>a.name.includes(b.value)||a.phone.includes(b.value)):g.value,we=()=>{k.value=!1},ye=a=>{V.value=a,z.value=!0},Y=()=>{z.value=!1,V.value=null};return Q(()=>{console.log("设备详情页加载，设备ID:",d),N(),E()}),(a,e)=>(y(),C("div",Oe,[l(c(Te),{title:"设备详情","left-arrow":"",onClickLeft:e[0]||(e[0]=()=>a.$router.back())}),l(Me,{height:"250px"}),t("div",He,[e[13]||(e[13]=t("h2",{class:"card-title"},"设备管理",-1)),t("div",Je,[t("div",qe,[e[9]||(e[9]=t("span",{class:"control-label"},"火柴人模式",-1)),l(c(ae),{modelValue:v.value,"onUpdate:modelValue":e[1]||(e[1]=o=>v.value=o),disabled:m.value,size:"20px",onChange:ve},null,8,["modelValue","disabled"])]),t("div",Qe,[e[10]||(e[10]=t("span",{class:"control-label"},"人像隐去",-1)),l(c(ae),{modelValue:m.value,"onUpdate:modelValue":e[2]||(e[2]=o=>m.value=o),size:"20px",onChange:fe},null,8,["modelValue"])]),t("div",{class:"control-item action-item",onClick:me},[e[11]||(e[11]=t("span",{class:"control-label"},"配置WIFI",-1)),l(c(T),{name:"arrow"})]),t("div",{class:"control-item action-item",onClick:ge},[e[12]||(e[12]=t("span",{class:"control-label"},"通知人管理",-1)),l(c(T),{name:"arrow"})])])]),t("div",Ke,[e[14]||(e[14]=t("h2",{class:"section-title"},"异常事件记录",-1)),l(c(je),{"column-num":2,border:!1,gutter:"10"},{default:I(()=>[(y(!0),C(G,null,M(x.value,o=>(y(),Ee(c(De),{key:o.id,onClick:r=>ye(o)},{default:I(()=>[t("div",Xe,[l(c(ie),{src:o.url,width:"100%",height:"100px",fit:"cover",radius:"8"},null,8,["src"]),t("div",Ye,$(o.timestamp),1)])]),_:2},1032,["onClick"]))),128))]),_:1})]),l(c(A),{show:u.value,"onUpdate:show":e[5]||(e[5]=o=>u.value=o),position:"bottom",style:{height:"50%"},round:""},{default:I(()=>[t("div",Ze,[e[17]||(e[17]=t("div",{class:"popup-header"},[t("h2",null,"配置WIFI")],-1)),t("div",eo,[l(c(O),{modelValue:i.value.ssid,"onUpdate:modelValue":e[3]||(e[3]=o=>i.value.ssid=o),label:"WIFI名称",placeholder:"请输入WIFI名称",clearable:""},null,8,["modelValue"]),l(c(O),{modelValue:i.value.password,"onUpdate:modelValue":e[4]||(e[4]=o=>i.value.password=o),type:"password",label:"WIFI密码",placeholder:"请输入WIFI密码",clearable:""},null,8,["modelValue"])]),t("div",oo,[l(c(D),{block:"",round:"",onClick:he,style:{margin:"0 10px 10px 10px"}},{default:I(()=>e[15]||(e[15]=[F(" 取消 ",-1)])),_:1,__:[15]}),l(c(D),{type:"primary",block:"",round:"",onClick:pe,style:{margin:"0 10px 10px 10px"}},{default:I(()=>e[16]||(e[16]=[F(" 确认 ",-1)])),_:1,__:[16]})])])]),_:1},8,["show"]),l(c(A),{show:k.value,"onUpdate:show":e[7]||(e[7]=o=>k.value=o),position:"bottom",style:{height:"80%"},round:""},{default:I(()=>[t("div",to,[t("div",so,[e[18]||(e[18]=t("h2",null,"通知人管理",-1)),l(c(T),{name:"cross",class:"close-icon",onClick:we})]),t("div",ao,[t("div",io,[e[19]||(e[19]=t("h3",null,"搜索联系人",-1)),t("div",no,[l(c(O),{modelValue:b.value,"onUpdate:modelValue":e[6]||(e[6]=o=>b.value=o),placeholder:"通过昵称或手机号搜索",clearable:""},{"right-icon":I(()=>[l(c(T),{name:"search"})]),_:1},8,["modelValue"])])]),t("div",lo,[e[21]||(e[21]=t("h3",null,"已有通知人",-1)),(y(!0),C(G,null,M(j().filter(o=>o.isNotifier),o=>(y(),C("div",{key:o.phone,class:"notifier-item"},[t("div",ro,[t("div",co,$(o.name),1),t("div",uo,$(o.phone),1)]),l(c(D),{size:"small",onClick:r=>X(o.phone)},{default:I(()=>e[20]||(e[20]=[F(" 取消通知 ",-1)])),_:2,__:[20]},1032,["onClick"])]))),128)),j().filter(o=>o.isNotifier).length===0?(y(),C("div",vo," 暂无通知人 ")):H("",!0)]),t("div",fo,[e[23]||(e[23]=t("h3",null,"添加新通知人",-1)),(y(!0),C(G,null,M(j().filter(o=>!o.isNotifier),o=>(y(),C("div",{key:o.phone,class:"notifier-item"},[t("div",mo,[t("div",po,$(o.name),1),t("div",ho,$(o.phone),1)]),l(c(D),{type:"primary",size:"small",onClick:r=>X(o.phone)},{default:I(()=>e[22]||(e[22]=[F(" 添加通知 ",-1)])),_:2,__:[22]},1032,["onClick"])]))),128)),j().filter(o=>!o.isNotifier).length===0?(y(),C("div",go," 暂无其他联系人 ")):H("",!0)])])])]),_:1},8,["show"]),l(c(A),{show:z.value,"onUpdate:show":e[8]||(e[8]=o=>z.value=o),position:"center",style:{width:"90%",height:"80%",maxWidth:"800px"},round:"",closeable:"",onClickCloseIcon:Y,onClickOverlay:Y},{default:I(()=>[V.value?(y(),C("div",wo,[l(c(ie),{src:V.value.url,fit:"contain",class:"lightbox-image"},null,8,["src"]),t("div",yo,[t("div",ko,$(V.value.timestamp),1)])])):H("",!0)]),_:1},8,["show"])]))}}),xo=re(bo,[["__scopeId","data-v-4c67408f"]]);export{xo as default};
