import{d as H,v as W,x as L,y as ne,z as Ce,a as i,A as U,L as Ve,C as ie,D as Y,E as Z,r as h,G as xe,H as Pe,J as $e,K as ze,M as Se,O as Te,o as le,Q as ee,R as Ne,S as Le,U as oe,I as j,n as je,c as P,b as t,u,N as Ee,w as C,P as A,e as m,F as R,h as G,j as O,B as D,i as F,g as M,t as z,V as se,l as q,p as V,q as De,f as Fe,_ as Ue}from"./index-CmUdAjUI.js";import{V as Be}from"./VideoPlayer-DIncmyp4.js";import{G as We,a as Ae}from"./index-BHBJN7X8.js";const[Re,J]=ne("switch"),Ge={size:L,loading:Boolean,disabled:Boolean,modelValue:W,activeColor:String,inactiveColor:String,activeValue:{type:W,default:!0},inactiveValue:{type:W,default:!1}};var Oe=H({name:Re,props:Ge,emits:["change","update:modelValue"],setup(a,{emit:$,slots:r}){const g=()=>a.modelValue===a.activeValue,l=()=>{if(!a.disabled&&!a.loading){const v=g()?a.inactiveValue:a.activeValue;$("update:modelValue",v),$("change",v)}},f=()=>{if(a.loading){const v=g()?a.activeColor:a.inactiveColor;return i(Ve,{class:J("loading"),color:v},null)}if(r.node)return r.node()};return Ce(()=>a.modelValue),()=>{var v;const{size:x,loading:c,disabled:b,activeColor:I,inactiveColor:w}=a,y=g(),p={fontSize:U(x),backgroundColor:y?I:w};return i("div",{role:"switch",class:J({on:y,loading:c,disabled:b}),style:p,tabindex:b?void 0:0,"aria-checked":y,onClick:l},[i("div",{class:J("node")},[f()]),(v=r.background)==null?void 0:v.call(r)])}}});const te=ie(Oe),[Me,S]=ne("image"),qe={src:String,alt:String,fit:String,position:String,round:Boolean,block:Boolean,width:L,height:L,radius:L,lazyLoad:Boolean,iconSize:L,showError:Z,errorIcon:Y("photo-fail"),iconPrefix:String,showLoading:Z,loadingIcon:Y("photo"),crossorigin:String,referrerpolicy:String,decoding:String};var Je=H({name:Me,props:qe,emits:["load","error"],setup(a,{emit:$,slots:r}){const g=h(!1),l=h(!0),f=h(),{$Lazyload:v}=xe().proxy,x=Pe(()=>{const n={width:U(a.width),height:U(a.height)};return $e(a.radius)&&(n.overflow="hidden",n.borderRadius=U(a.radius)),n});ze(()=>a.src,()=>{g.value=!1,l.value=!0});const c=n=>{l.value&&(l.value=!1,$("load",n))},b=()=>{const n=new Event("load");Object.defineProperty(n,"target",{value:f.value,enumerable:!0}),c(n)},I=n=>{g.value=!0,l.value=!1,$("error",n)},w=(n,_,k)=>k?k():i(j,{name:n,size:a.iconSize,class:_,classPrefix:a.iconPrefix},null),y=()=>{if(l.value&&a.showLoading)return i("div",{class:S("loading")},[w(a.loadingIcon,S("loading-icon"),r.loading)]);if(g.value&&a.showError)return i("div",{class:S("error")},[w(a.errorIcon,S("error-icon"),r.error)])},p=()=>{if(g.value||!a.src)return;const n={alt:a.alt,class:S("img"),decoding:a.decoding,style:{objectFit:a.fit,objectPosition:a.position},crossorigin:a.crossorigin,referrerpolicy:a.referrerpolicy};return a.lazyLoad?Ne(i("img",oe({ref:f},n),null),[[Le("lazy"),a.src]]):i("img",oe({ref:f,src:a.src,onLoad:c,onError:I},n),null)},T=({el:n})=>{const _=()=>{n===f.value&&l.value&&b()};f.value?_():ee(_)},N=({el:n})=>{n===f.value&&!g.value&&I()};return v&&Se&&(v.$on("loaded",T),v.$on("error",N),Te(()=>{v.$off("loaded",T),v.$off("error",N)})),le(()=>{ee(()=>{var n;(n=f.value)!=null&&n.complete&&!a.lazyLoad&&b()})}),()=>{var n;return i("div",{class:S({round:a.round,block:a.block}),style:x.value},[p(),y(),(n=r.default)==null?void 0:n.call(r)])}}});const ae=ie(Je),He={class:"device-detail-page"},Qe={class:"device-controls-card"},Ke={class:"control-list"},Xe={class:"control-item"},Ye={class:"control-item"},Ze={class:"exception-images"},eo={class:"image-item"},oo={class:"image-timestamp"},so={class:"wifi-popup"},to={class:"popup-content"},ao={class:"popup-footer"},no={class:"notifier-popup"},io={class:"popup-header"},lo={class:"popup-content"},ro={class:"search-section"},co={class:"search-bar"},uo={class:"notifier-section"},vo={class:"notifier-info"},fo={class:"notifier-name"},ho={class:"notifier-phone"},mo={key:0,class:"empty-state"},po={class:"notifier-section"},go={class:"notifier-info"},wo={class:"notifier-name"},yo={class:"notifier-phone"},ko={key:0,class:"empty-state"},bo={key:0,class:"image-lightbox"},Io={class:"lightbox-info"},_o={class:"image-timestamp"},Co=H({__name:"DeviceDetailView",setup(a){const $=je(),r=$.query.deviceId||"",g=$.query.boxId||"";console.log("deviceId:",r,"boxId:",g);const l=h(""),f=h(!1),v=h(!1),x=h(!1),c=h({ssid:"",password:""}),b=h(!1),I=h(""),w=h([]),y=h([]),p=h({}),T=h([]),N=h([]),n=h(!1),_=h(null),k=()=>localStorage.getItem("authToken")||"",re=async()=>{const s=k();try{const o=await(await fetch(`http://121.40.120.244:8080/realtime/play?deviceId=${r}&protocol=HTTPS_FLV`,{method:"GET",headers:{Authorization:s,"Content-Type":"application/json"}})).json();o.code===200?(p.value=o.data,console.log("获取流地址:",o.data),p.value.wifiName&&(c.value.ssid=p.value.wifiName),p.value.wifiPassword&&(c.value.password=p.value.wifiPassword),p.value?(l.value=p.value,console.log("流地址：",l.value)):l.value="https://asdasdnaoshidhaosi.icu/live/stream.live.flv"):m("获取设备信息失败")}catch(e){console.error("请求失败",e),m("网络错误，请重试")}},ce=async()=>{const s=k();try{const o=await(await fetch(`http://121.40.120.244:8080/stickman/warning/box/${g}`,{method:"GET",headers:{Authorization:s,"Content-Type":"application/json"}})).json();o.code===200?(N.value=o.data,T.value=N.value.map(d=>({id:d.id,url:d.combinedImageUrl||d.processedImageUrl||d.imageUrl||"https://picsum.photos/300/200?random=1",timestamp:d.time?new Date(d.time).toLocaleString():""}))):m("获取设备历史异常信息失败")}catch(e){console.error("请求失败",e),m("网络错误，请重试")}},de=async()=>{const s=k();console.log("Token:",s);try{const o=await(await fetch("http://121.40.120.244:8080/stickman/recipient_directory",{method:"GET",headers:{Authorization:s,"Content-Type":"application/json"}})).json();console.log("获取联系人列表:",o),o.code===200?(w.value=o.data,B()):m("获取联系人失败")}catch(e){console.error("请求失败",e),m("网络错误，请重试")}},B=()=>{w.value=w.value.map(s=>({...s,isNotifier:y.value.some(e=>e.phone===s.phone)}))},Q=async s=>{const e=k();try{const d=await(await fetch(`http://121.40.120.244:8080/stickman/recipient?boxId=${s}&page=1&size=10`,{method:"GET",headers:{Authorization:e,"Content-Type":"application/json"}})).json();d.code===200?(console.log(d.data.records),y.value=d.data.records,B()):m("获取设备通知人失败")}catch(o){console.error("请求失败",o),m("网络错误，请重试")}},ue=async s=>{const e=k();try{const d=await(await fetch("http://121.40.120.244:8080/stickman/recipient",{method:"POST",headers:{Authorization:e,"Content-Type":"application/json"},body:JSON.stringify({boxId:parseInt(r),name:s.name,phone:s.phoneNumber})})).json();d.code===200?(console.log(d),q("绑定成功"),await Q(r)):m("绑定失败")}catch{m("网络错误，请重试")}},ve=async s=>{const e=parseInt(y.value[s].id,10),o=k();if(confirm("你确定要解绑这个设备通知人吗？"))try{(await(await fetch(`http://121.40.120.244:8080/stickman/recipient/${e}`,{method:"DELETE",headers:{Authorization:o,"Content-Type":"application/json"}})).json()).code===200?(y.value.splice(s,1),q("解绑成功"),B()):m("解绑失败")}catch{m("请求失败")}},K=async s=>{const e=w.value.find(o=>o.phone===s);if(e)if(e.isNotifier){const o=y.value.findIndex(d=>d.phone===s);o!==-1&&await ve(o)}else await ue(e)},fe=async s=>{const e=k();try{s&&(f.value=s,l.value=`https://asdasdnaoshidhaosi.icu/inference/${r}.live.flv`,(await(await fetch(`http://121.40.120.244:8080/realtime/inference?deviceId=${r}`,{method:"POST",headers:{Authorization:e,"Content-Type":"application/json"}})).json()).code===200?(console.log("火柴人请求成功url:",l.value),f.value=s,l.value=`https://asdasdnaoshidhaosi.icu/inference/${r}.live.flv`,console.log("火柴人url:",l.value)):(f.value=!s,console.log("火柴人url:",l.value)))}catch(o){f.value=!s,console.error("火柴人模式切换请求失败:",o),m("网络错误，请重试")}finally{console.log("火柴人模式状态:",s?"on":"off"),Fe()}console.log("火柴人模式状态:",s?"on":"off"),s||(l.value=p.value,console.log("url:",l.value))},he=s=>{v.value=s,console.log("人像隐去状态:",s?"on":"off"),s?(f.value=!0,l.value=`https://asdasdnaoshidhaosi.icu/inference/${r}_hidden.live.flv`,console.log("隐去人像url:",l.value)):l.value=`https://asdasdnaoshidhaosi.icu/inference/${r}.live.flv`},me=()=>{x.value=!0},pe=async()=>{if(!c.value.ssid){se("请输入WIFI名称");return}if(!c.value.password){se("请输入WIFI密码");return}const s=k();try{const o=await(await fetch(`http://121.40.120.244:8080/stickman/box/${r}`,{method:"PUT",headers:{Authorization:s,"Content-Type":"application/json"},body:JSON.stringify({...p.value,wifiName:c.value.ssid,wifiPassword:c.value.password})})).json();o.code===200?(console.log("RES:",o),q("修改设备配置信息成功"),p.value.wifiName=c.value.ssid,p.value.wifiPassword=c.value.password,c.value.ssid="",c.value.password="",x.value=!1):m("修改设备配置信息失败")}catch(e){console.error("请求失败",e),m("网络错误，请重试")}},ge=()=>{c.value.ssid="",c.value.password="",x.value=!1},we=async()=>{b.value=!0,await Q(r),await de()},E=()=>I.value?w.value.filter(s=>s.name.includes(I.value)||s.phone.includes(I.value)):w.value,ye=()=>{b.value=!1},ke=s=>{_.value=s,n.value=!0},X=()=>{n.value=!1,_.value=null},be=()=>{console.log("视频开始播放")},Ie=()=>{console.log("视频已暂停")},_e=s=>{console.error("视频播放错误:",s),m("视频播放失败: "+s)};return le(()=>{console.log("设备详情页加载，设备ID:",r),re(),ce()}),(s,e)=>(V(),P("div",He,[i(u(Ee),{title:"设备详情","left-arrow":"",onClickLeft:e[0]||(e[0]=()=>s.$router.back())}),i(Be,{height:"250px","video-url":l.value,onPlay:be,onPause:Ie,onError:_e},null,8,["video-url"]),t("div",Qe,[e[13]||(e[13]=t("h2",{class:"card-title"},"设备管理",-1)),t("div",Ke,[t("div",Xe,[e[9]||(e[9]=t("span",{class:"control-label"},"火柴人模式",-1)),i(u(te),{modelValue:f.value,"onUpdate:modelValue":e[1]||(e[1]=o=>f.value=o),disabled:v.value,size:"20px",onChange:fe},null,8,["modelValue","disabled"])]),t("div",Ye,[e[10]||(e[10]=t("span",{class:"control-label"},"人像隐去",-1)),i(u(te),{modelValue:v.value,"onUpdate:modelValue":e[2]||(e[2]=o=>v.value=o),size:"20px",onChange:he},null,8,["modelValue"])]),t("div",{class:"control-item action-item",onClick:me},[e[11]||(e[11]=t("span",{class:"control-label"},"配置WIFI",-1)),i(u(j),{name:"arrow"})]),t("div",{class:"control-item action-item",onClick:we},[e[12]||(e[12]=t("span",{class:"control-label"},"通知人管理",-1)),i(u(j),{name:"arrow"})])])]),t("div",Ze,[e[14]||(e[14]=t("h2",{class:"section-title"},"异常事件记录",-1)),i(u(We),{"column-num":2,border:!1,gutter:"10"},{default:C(()=>[(V(!0),P(R,null,G(T.value,o=>(V(),De(u(Ae),{key:o.id,onClick:d=>ke(o)},{default:C(()=>[t("div",eo,[i(u(ae),{src:o.url,width:"100%",height:"100px",fit:"cover",radius:"8"},null,8,["src"]),t("div",oo,z(o.timestamp),1)])]),_:2},1032,["onClick"]))),128))]),_:1})]),i(u(A),{show:x.value,"onUpdate:show":e[5]||(e[5]=o=>x.value=o),position:"bottom",style:{height:"50%"},round:""},{default:C(()=>[t("div",so,[e[17]||(e[17]=t("div",{class:"popup-header"},[t("h2",null,"配置WIFI")],-1)),t("div",to,[i(u(O),{modelValue:c.value.ssid,"onUpdate:modelValue":e[3]||(e[3]=o=>c.value.ssid=o),label:"WIFI名称",placeholder:"请输入WIFI名称",clearable:""},null,8,["modelValue"]),i(u(O),{modelValue:c.value.password,"onUpdate:modelValue":e[4]||(e[4]=o=>c.value.password=o),type:"password",label:"WIFI密码",placeholder:"请输入WIFI密码",clearable:""},null,8,["modelValue"])]),t("div",ao,[i(u(D),{block:"",round:"",onClick:ge,style:{margin:"0 10px 10px 10px"}},{default:C(()=>e[15]||(e[15]=[F(" 取消 ",-1)])),_:1,__:[15]}),i(u(D),{type:"primary",block:"",round:"",onClick:pe,style:{margin:"0 10px 10px 10px"}},{default:C(()=>e[16]||(e[16]=[F(" 确认 ",-1)])),_:1,__:[16]})])])]),_:1},8,["show"]),i(u(A),{show:b.value,"onUpdate:show":e[7]||(e[7]=o=>b.value=o),position:"bottom",style:{height:"80%"},round:""},{default:C(()=>[t("div",no,[t("div",io,[e[18]||(e[18]=t("h2",null,"通知人管理",-1)),i(u(j),{name:"cross",class:"close-icon",onClick:ye})]),t("div",lo,[t("div",ro,[e[19]||(e[19]=t("h3",null,"搜索联系人",-1)),t("div",co,[i(u(O),{modelValue:I.value,"onUpdate:modelValue":e[6]||(e[6]=o=>I.value=o),placeholder:"通过昵称或手机号搜索",clearable:""},{"right-icon":C(()=>[i(u(j),{name:"search"})]),_:1},8,["modelValue"])])]),t("div",uo,[e[21]||(e[21]=t("h3",null,"已有通知人",-1)),(V(!0),P(R,null,G(E().filter(o=>o.isNotifier),o=>(V(),P("div",{key:o.phone,class:"notifier-item"},[t("div",vo,[t("div",fo,z(o.name),1),t("div",ho,z(o.phone),1)]),i(u(D),{size:"small",onClick:d=>K(o.phone)},{default:C(()=>e[20]||(e[20]=[F(" 取消通知 ",-1)])),_:2,__:[20]},1032,["onClick"])]))),128)),E().filter(o=>o.isNotifier).length===0?(V(),P("div",mo," 暂无通知人 ")):M("",!0)]),t("div",po,[e[23]||(e[23]=t("h3",null,"添加新通知人",-1)),(V(!0),P(R,null,G(E().filter(o=>!o.isNotifier),o=>(V(),P("div",{key:o.phone,class:"notifier-item"},[t("div",go,[t("div",wo,z(o.name),1),t("div",yo,z(o.phone),1)]),i(u(D),{type:"primary",size:"small",onClick:d=>K(o.phone)},{default:C(()=>e[22]||(e[22]=[F(" 添加通知 ",-1)])),_:2,__:[22]},1032,["onClick"])]))),128)),E().filter(o=>!o.isNotifier).length===0?(V(),P("div",ko," 暂无其他联系人 ")):M("",!0)])])])]),_:1},8,["show"]),i(u(A),{show:n.value,"onUpdate:show":e[8]||(e[8]=o=>n.value=o),position:"center",style:{width:"90%",height:"80%",maxWidth:"800px"},round:"",closeable:"",onClickCloseIcon:X,onClickOverlay:X},{default:C(()=>[_.value?(V(),P("div",bo,[i(u(ae),{src:_.value.url,fit:"contain",class:"lightbox-image"},null,8,["src"]),t("div",Io,[t("div",_o,z(_.value.timestamp),1)])])):M("",!0)]),_:1},8,["show"])]))}}),zo=Ue(Co,[["__scopeId","data-v-221a8ee6"]]);export{zo as default};
