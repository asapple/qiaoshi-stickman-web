import{d as H,v as W,x as N,y as ae,z as _e,a as i,A as U,L as be,C as ne,D as Y,E as Z,r as h,G as Ce,H as xe,J as Ve,K as Te,M as Pe,O as $e,o as ie,Q as ee,R as ze,S as Se,U as oe,I as L,n as Ne,c as x,b as a,u as d,N as Le,w as _,P as A,e as p,F as R,h as G,j as O,B as D,i as F,g as M,t as $,V as te,l as q,p as b,q as je,f as Ee,_ as De}from"./index-6nRFhmNz.js";import{V as Fe}from"./VideoPlayer-occrxD-T.js";import{G as Ue,a as Be}from"./index-CW9O1qbA.js";const[We,J]=ae("switch"),Ae={size:N,loading:Boolean,disabled:Boolean,modelValue:W,activeColor:String,inactiveColor:String,activeValue:{type:W,default:!0},inactiveValue:{type:W,default:!1}};var Re=H({name:We,props:Ae,emits:["change","update:modelValue"],setup(s,{emit:V,slots:l}){const w=()=>s.modelValue===s.activeValue,v=()=>{if(!s.disabled&&!s.loading){const u=w()?s.inactiveValue:s.activeValue;V("update:modelValue",u),V("change",u)}},m=()=>{if(s.loading){const u=w()?s.activeColor:s.inactiveColor;return i(be,{class:J("loading"),color:u},null)}if(l.node)return l.node()};return _e(()=>s.modelValue),()=>{var u;const{size:c,loading:C,disabled:y,activeColor:k,inactiveColor:I}=s,f=w(),P={fontSize:U(c),backgroundColor:f?k:I};return i("div",{role:"switch",class:J({on:f,loading:C,disabled:y}),style:P,tabindex:y?void 0:0,"aria-checked":f,onClick:v},[i("div",{class:J("node")},[m()]),(u=l.background)==null?void 0:u.call(l)])}}});const Ge=ne(Re),[Oe,z]=ae("image"),Me={src:String,alt:String,fit:String,position:String,round:Boolean,block:Boolean,width:N,height:N,radius:N,lazyLoad:Boolean,iconSize:N,showError:Z,errorIcon:Y("photo-fail"),iconPrefix:String,showLoading:Z,loadingIcon:Y("photo"),crossorigin:String,referrerpolicy:String,decoding:String};var qe=H({name:Oe,props:Me,emits:["load","error"],setup(s,{emit:V,slots:l}){const w=h(!1),v=h(!0),m=h(),{$Lazyload:u}=Ce().proxy,c=xe(()=>{const n={width:U(s.width),height:U(s.height)};return Ve(s.radius)&&(n.overflow="hidden",n.borderRadius=U(s.radius)),n});Te(()=>s.src,()=>{w.value=!1,v.value=!0});const C=n=>{v.value&&(v.value=!1,V("load",n))},y=()=>{const n=new Event("load");Object.defineProperty(n,"target",{value:m.value,enumerable:!0}),C(n)},k=n=>{w.value=!0,v.value=!1,V("error",n)},I=(n,g,j)=>j?j():i(L,{name:n,size:s.iconSize,class:g,classPrefix:s.iconPrefix},null),f=()=>{if(v.value&&s.showLoading)return i("div",{class:z("loading")},[I(s.loadingIcon,z("loading-icon"),l.loading)]);if(w.value&&s.showError)return i("div",{class:z("error")},[I(s.errorIcon,z("error-icon"),l.error)])},P=()=>{if(w.value||!s.src)return;const n={alt:s.alt,class:z("img"),decoding:s.decoding,style:{objectFit:s.fit,objectPosition:s.position},crossorigin:s.crossorigin,referrerpolicy:s.referrerpolicy};return s.lazyLoad?ze(i("img",oe({ref:m},n),null),[[Se("lazy"),s.src]]):i("img",oe({ref:m,src:s.src,onLoad:C,onError:k},n),null)},S=({el:n})=>{const g=()=>{n===m.value&&v.value&&y()};m.value?g():ee(g)},T=({el:n})=>{n===m.value&&!w.value&&k()};return u&&Pe&&(u.$on("loaded",S),u.$on("error",T),$e(()=>{u.$off("loaded",S),u.$off("error",T)})),ie(()=>{ee(()=>{var n;(n=m.value)!=null&&n.complete&&!s.lazyLoad&&y()})}),()=>{var n;return i("div",{class:z({round:s.round,block:s.block}),style:c.value},[P(),f(),(n=l.default)==null?void 0:n.call(l)])}}});const se=ne(qe),Je={class:"device-detail-page"},He={class:"device-controls-card"},Qe={class:"control-list"},Ke={class:"control-item"},Xe={class:"exception-images"},Ye={class:"image-item"},Ze={class:"image-timestamp"},eo={class:"wifi-popup"},oo={class:"popup-content"},to={class:"popup-footer"},so={class:"notifier-popup"},ao={class:"popup-header"},no={class:"popup-content"},io={class:"search-section"},lo={class:"search-bar"},ro={class:"notifier-section"},co={class:"notifier-info"},uo={class:"notifier-name"},vo={class:"notifier-phone"},fo={key:0,class:"empty-state"},mo={class:"notifier-section"},po={class:"notifier-info"},ho={class:"notifier-name"},go={class:"notifier-phone"},wo={key:0,class:"empty-state"},yo={key:0,class:"image-lightbox"},ko={class:"lightbox-info"},Io={class:"image-timestamp"},_o=H({__name:"DeviceDetailView",setup(s){const V=Ne(),l=V.query.deviceId||"",w=V.query.boxId||"";console.log("deviceId:",l,"boxId:",w);const v=h(""),m=h(!1),u=h(!1),c=h({ssid:"",password:""}),C=h(!1),y=h(""),k=h([]),I=h([]),f=h({}),P=h([]),S=h([]),T=h(!1),n=h(null),g=()=>localStorage.getItem("authToken")||"",j=async()=>{const t=g();try{const o=await(await fetch(`http://121.40.120.244:8080/realtime/play?deviceId=${l}&protocol=HTTPS_FLV`,{method:"GET",headers:{Authorization:t,"Content-Type":"application/json"}})).json();o.code===200?(f.value=o.data,console.log("获取流地址:",o.data),f.value.wifiName&&(c.value.ssid=f.value.wifiName),f.value.wifiPassword&&(c.value.password=f.value.wifiPassword),f.value?setTimeout(()=>{v.value=f.value,console.log("流地址：",v.value)},2e3):setTimeout(()=>{v.value="https://47.118.84.20/live/stream.live.flv"},2e3)):p("获取设备信息失败")}catch(e){console.error("请求失败",e),p("网络错误，请重试")}},le=async()=>{const t=g();try{const o=await(await fetch(`http://121.40.120.244:8080/stickman/warning/box/${w}`,{method:"GET",headers:{Authorization:t,"Content-Type":"application/json"}})).json();o.code===200?(S.value=o.data,P.value=S.value.map(r=>({id:r.id,url:r.combinedImageUrl||r.processedImageUrl||r.imageUrl||"https://picsum.photos/300/200?random=1",timestamp:r.time?new Date(r.time).toLocaleString():""}))):p("获取设备历史异常信息失败")}catch(e){console.error("请求失败",e),p("网络错误，请重试")}},re=async()=>{const t=g();console.log("Token:",t);try{const o=await(await fetch("http://121.40.120.244:8080/stickman/recipient_directory",{method:"GET",headers:{Authorization:t,"Content-Type":"application/json"}})).json();console.log("获取联系人列表:",o),o.code===200?(k.value=o.data,B()):p("获取联系人失败")}catch(e){console.error("请求失败",e),p("网络错误，请重试")}},B=()=>{k.value=k.value.map(t=>({...t,isNotifier:I.value.some(e=>e.phone===t.phone)}))},Q=async t=>{const e=g();try{const r=await(await fetch(`http://121.40.120.244:8080/stickman/recipient?boxId=${t}&page=1&size=10`,{method:"GET",headers:{Authorization:e,"Content-Type":"application/json"}})).json();r.code===200?(console.log(r.data.records),I.value=r.data.records,B()):p("获取设备通知人失败")}catch(o){console.error("请求失败",o),p("网络错误，请重试")}},ce=async t=>{const e=g();try{const r=await(await fetch("http://121.40.120.244:8080/stickman/recipient",{method:"POST",headers:{Authorization:e,"Content-Type":"application/json"},body:JSON.stringify({boxId:parseInt(l),name:t.name,phone:t.phoneNumber})})).json();r.code===200?(console.log(r),q("绑定成功"),await Q(l)):p("绑定失败")}catch{p("网络错误，请重试")}},de=async t=>{const e=parseInt(I.value[t].id,10),o=g();if(confirm("你确定要解绑这个设备通知人吗？"))try{(await(await fetch(`http://121.40.120.244:8080/stickman/recipient/${e}`,{method:"DELETE",headers:{Authorization:o,"Content-Type":"application/json"}})).json()).code===200?(I.value.splice(t,1),q("解绑成功"),B()):p("解绑失败")}catch{p("请求失败")}},K=async t=>{const e=k.value.find(o=>o.phone===t);if(e)if(e.isNotifier){const o=I.value.findIndex(r=>r.phone===t);o!==-1&&await de(o)}else await ce(e)},ue=async t=>{const e=g();console.log("隐去人像状态1:",t?"on":"off");try{if(t){m.value=t;const o=`https://47.118.84.20:443/inference/${l}_hidden.live.flv`;console.log("隐去人像url：",o),(await(await fetch(`http://121.40.120.244:8080/realtime/inference?deviceId=${l}&rtsp=rtsp://47.118.84.20:554/rtp/${l}_hidden_${l}`,{method:"POST",headers:{Authorization:e,"Content-Type":"application/json"}})).json()).code===200?(console.log("隐去人像请求成功url:",o),m.value=t,setTimeout(()=>{v.value=o,console.log("隐去人像成功url:",v.value)},3e3)):(m.value=!1,console.log("隐去人像请求失败"))}}catch(o){console.error("隐去人像模式切换请求失败:",o),p("网络错误，请重试")}finally{console.log("隐去人像状态:",t?"on":"off"),Ee()}t||(m.value=t,setTimeout(()=>{v.value=f.value,console.log("url:",v.value)},2e3))},ve=()=>{u.value=!0},fe=async()=>{if(!c.value.ssid){te("请输入WIFI名称");return}if(!c.value.password){te("请输入WIFI密码");return}const t=g();try{const o=await(await fetch(`http://121.40.120.244:8080/stickman/box/${l}`,{method:"PUT",headers:{Authorization:t,"Content-Type":"application/json"},body:JSON.stringify({...f.value,wifiName:c.value.ssid,wifiPassword:c.value.password})})).json();o.code===200?(console.log("RES:",o),q("修改设备配置信息成功"),f.value.wifiName=c.value.ssid,f.value.wifiPassword=c.value.password,c.value.ssid="",c.value.password="",u.value=!1):p("修改设备配置信息失败")}catch(e){console.error("请求失败",e),p("网络错误，请重试")}},me=()=>{c.value.ssid="",c.value.password="",u.value=!1},pe=async()=>{C.value=!0,await Q(l),await re()},E=()=>y.value?k.value.filter(t=>t.name.includes(y.value)||t.phone.includes(y.value)):k.value,he=()=>{C.value=!1},ge=t=>{n.value=t,T.value=!0},X=()=>{T.value=!1,n.value=null},we=()=>{console.log("视频开始播放")},ye=()=>{console.log("视频已暂停")},ke=t=>{console.error("视频播放错误:",t),p("视频播放失败: "+t)};return ie(()=>{console.log("设备详情页加载，设备ID:",l),j(),le()}),(t,e)=>(b(),x("div",Je,[i(d(Le),{title:"设备详情","left-arrow":"",onClickLeft:e[0]||(e[0]=()=>t.$router.back())}),i(Fe,{height:"250px","video-url":v.value,onPlay:we,onPause:ye,onError:ke},null,8,["video-url"]),a("div",He,[e[11]||(e[11]=a("h2",{class:"card-title"},"设备管理",-1)),a("div",Qe,[a("div",Ke,[e[8]||(e[8]=a("span",{class:"control-label"},"隐去人像",-1)),i(d(Ge),{modelValue:m.value,"onUpdate:modelValue":e[1]||(e[1]=o=>m.value=o),size:"20px",onChange:ue},null,8,["modelValue"])]),a("div",{class:"control-item action-item",onClick:ve},[e[9]||(e[9]=a("span",{class:"control-label"},"配置WIFI",-1)),i(d(L),{name:"arrow"})]),a("div",{class:"control-item action-item",onClick:pe},[e[10]||(e[10]=a("span",{class:"control-label"},"通知人管理",-1)),i(d(L),{name:"arrow"})])])]),a("div",Xe,[e[12]||(e[12]=a("h2",{class:"section-title"},"异常事件记录",-1)),i(d(Ue),{"column-num":2,border:!1,gutter:"10"},{default:_(()=>[(b(!0),x(R,null,G(P.value,o=>(b(),je(d(Be),{key:o.id,onClick:r=>ge(o)},{default:_(()=>[a("div",Ye,[i(d(se),{src:o.url,width:"100%",height:"100px",fit:"cover",radius:"8"},null,8,["src"]),a("div",Ze,$(o.timestamp),1)])]),_:2},1032,["onClick"]))),128))]),_:1})]),i(d(A),{show:u.value,"onUpdate:show":e[4]||(e[4]=o=>u.value=o),position:"bottom",style:{height:"50%"},round:""},{default:_(()=>[a("div",eo,[e[15]||(e[15]=a("div",{class:"popup-header"},[a("h2",null,"配置WIFI")],-1)),a("div",oo,[i(d(O),{modelValue:c.value.ssid,"onUpdate:modelValue":e[2]||(e[2]=o=>c.value.ssid=o),label:"WIFI名称",placeholder:"请输入WIFI名称",clearable:""},null,8,["modelValue"]),i(d(O),{modelValue:c.value.password,"onUpdate:modelValue":e[3]||(e[3]=o=>c.value.password=o),type:"password",label:"WIFI密码",placeholder:"请输入WIFI密码",clearable:""},null,8,["modelValue"])]),a("div",to,[i(d(D),{block:"",round:"",onClick:me,style:{margin:"0 10px 10px 10px"}},{default:_(()=>e[13]||(e[13]=[F(" 取消 ",-1)])),_:1,__:[13]}),i(d(D),{type:"primary",block:"",round:"",onClick:fe,style:{margin:"0 10px 10px 10px"}},{default:_(()=>e[14]||(e[14]=[F(" 确认 ",-1)])),_:1,__:[14]})])])]),_:1},8,["show"]),i(d(A),{show:C.value,"onUpdate:show":e[6]||(e[6]=o=>C.value=o),position:"bottom",style:{height:"80%"},round:""},{default:_(()=>[a("div",so,[a("div",ao,[e[16]||(e[16]=a("h2",null,"通知人管理",-1)),i(d(L),{name:"cross",class:"close-icon",onClick:he})]),a("div",no,[a("div",io,[e[17]||(e[17]=a("h3",null,"搜索联系人",-1)),a("div",lo,[i(d(O),{modelValue:y.value,"onUpdate:modelValue":e[5]||(e[5]=o=>y.value=o),placeholder:"通过昵称或手机号搜索",clearable:""},{"right-icon":_(()=>[i(d(L),{name:"search"})]),_:1},8,["modelValue"])])]),a("div",ro,[e[19]||(e[19]=a("h3",null,"已有通知人",-1)),(b(!0),x(R,null,G(E().filter(o=>o.isNotifier),o=>(b(),x("div",{key:o.phone,class:"notifier-item"},[a("div",co,[a("div",uo,$(o.name),1),a("div",vo,$(o.phone),1)]),i(d(D),{size:"small",onClick:r=>K(o.phone)},{default:_(()=>e[18]||(e[18]=[F(" 取消通知 ",-1)])),_:2,__:[18]},1032,["onClick"])]))),128)),E().filter(o=>o.isNotifier).length===0?(b(),x("div",fo," 暂无通知人 ")):M("",!0)]),a("div",mo,[e[21]||(e[21]=a("h3",null,"添加新通知人",-1)),(b(!0),x(R,null,G(E().filter(o=>!o.isNotifier),o=>(b(),x("div",{key:o.phone,class:"notifier-item"},[a("div",po,[a("div",ho,$(o.name),1),a("div",go,$(o.phone),1)]),i(d(D),{type:"primary",size:"small",onClick:r=>K(o.phone)},{default:_(()=>e[20]||(e[20]=[F(" 添加通知 ",-1)])),_:2,__:[20]},1032,["onClick"])]))),128)),E().filter(o=>!o.isNotifier).length===0?(b(),x("div",wo," 暂无其他联系人 ")):M("",!0)])])])]),_:1},8,["show"]),i(d(A),{show:T.value,"onUpdate:show":e[7]||(e[7]=o=>T.value=o),position:"center",style:{width:"90%",height:"80%",maxWidth:"800px"},round:"",closeable:"",onClickCloseIcon:X,onClickOverlay:X},{default:_(()=>[n.value?(b(),x("div",yo,[i(d(se),{src:n.value.url,fit:"contain",class:"lightbox-image"},null,8,["src"]),a("div",ko,[a("div",Io,$(n.value.timestamp),1)])])):M("",!0)]),_:1},8,["show"])]))}}),Vo=De(_o,[["__scopeId","data-v-e20375c9"]]);export{Vo as default};
